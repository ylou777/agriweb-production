#!/usr/bin/env python3
"""
üöÄ D√âPLOIEMENT COMPLET AGRIWEB 2.0
Script tout-en-un pour le passage en production avec essai gratuit
"""

import os
import sys
import subprocess
import sqlite3
from datetime import datetime
from flask import Flask
import yaml

# Imports des modules de production
from production_system import create_production_app, LicenseManager
from production_integration import integrate_production_system
from payment_system import create_payment_routes
from geoserver_production_setup import GeoServerDeploymentHelper

class AgriWebProductionDeployer:
    """Gestionnaire de d√©ploiement complet pour AgriWeb 2.0"""
    
    def __init__(self):
        self.deployment_config = {
            "app_name": "AgriWeb 2.0",
            "version": "2.0.0",
            "deployment_date": datetime.now().isoformat(),
            "features": [
                "trial_system",
                "license_management", 
                "stripe_payments",
                "geoserver_adaptation",
                "department_reports",
                "interactive_maps"
            ]
        }
        
    def check_requirements(self):
        """V√©rifie les pr√©requis pour le d√©ploiement"""
        
        print("üîç V√©rification des pr√©requis...")
        
        requirements = {
            "Python >= 3.8": self.check_python_version(),
            "Flask install√©": self.check_package("flask"),
            "Stripe install√©": self.check_package("stripe"),
            "Psycopg2 install√©": self.check_package("psycopg2-binary"),
            "Application existante": self.check_existing_app(),
            "Base de donn√©es SQLite": True  # SQLite est inclus avec Python
        }
        
        all_ok = True
        for req, status in requirements.items():
            status_icon = "‚úÖ" if status else "‚ùå"
            print(f"  {status_icon} {req}")
            if not status:
                all_ok = False
        
        if not all_ok:
            print("\n‚ùå Certains pr√©requis ne sont pas satisfaits.")
            print("Installez les d√©pendances manquantes avec :")
            print("pip install flask stripe psycopg2-binary requests pyyaml")
            return False
        
        print("‚úÖ Tous les pr√©requis sont satisfaits !")
        return True
    
    def check_python_version(self):
        """V√©rifie la version de Python"""
        return sys.version_info >= (3, 8)
    
    def check_package(self, package_name):
        """V√©rifie qu'un package Python est install√©"""
        try:
            __import__(package_name.replace('-', '_'))
            return True
        except ImportError:
            return False
    
    def check_existing_app(self):
        """V√©rifie si l'application AgriWeb existante est disponible"""
        try:
            from agriweb_source import app
            return True
        except ImportError:
            return False
    
    def setup_production_database(self):
        """Configure la base de donn√©es de production"""
        
        print("üóÑÔ∏è Configuration de la base de donn√©es...")
        
        # Initialiser le gestionnaire de licences
        license_manager = LicenseManager()
        
        # Ajouter des colonnes manquantes pour Stripe
        conn = sqlite3.connect(license_manager.db_path)
        cursor = conn.cursor()
        
        # V√©rifier et ajouter les colonnes Stripe si n√©cessaires
        cursor.execute("PRAGMA table_info(licenses)")
        columns = [column[1] for column in cursor.fetchall()]
        
        stripe_columns = [
            ("stripe_customer_id", "TEXT"),
            ("stripe_subscription_id", "TEXT"),
            ("is_paid", "BOOLEAN DEFAULT 0"),
            ("subscription_cancelled", "BOOLEAN DEFAULT 0"),
            ("cancelled_at", "TIMESTAMP"),
            ("deactivated_at", "TIMESTAMP")
        ]
        
        for col_name, col_type in stripe_columns:
            if col_name not in columns:
                cursor.execute(f"ALTER TABLE licenses ADD COLUMN {col_name} {col_type}")
                print(f"  ‚úÖ Colonne {col_name} ajout√©e")
        
        conn.commit()
        conn.close()
        
        print("‚úÖ Base de donn√©es configur√©e !")
    
    def create_production_app(self):
        """Cr√©e l'application Flask de production compl√®te"""
        
        print("üèóÔ∏è Cr√©ation de l'application de production...")
        
        # Int√©grer avec l'application existante si possible
        try:
            app = integrate_production_system()
            print("  ‚úÖ Int√©gration avec l'application existante")
        except Exception as e:
            print(f"  ‚ö†Ô∏è Erreur d'int√©gration : {e}")
            print("  üìù Cr√©ation d'une application de d√©monstration")
            app = self.create_demo_app()
        
        # Ajouter les routes de paiement
        create_payment_routes(app)
        print("  ‚úÖ Routes de paiement ajout√©es")
        
        # Configuration de production
        app.config.update({
            'ENV': 'production',
            'DEBUG': False,
            'TESTING': False,
            'SECRET_KEY': os.environ.get('SECRET_KEY', 'change-this-in-production'),
            'SQLALCHEMY_TRACK_MODIFICATIONS': False
        })
        
        return app
    
    def create_demo_app(self):
        """Cr√©e une application de d√©monstration si l'app principale n'est pas disponible"""
        
        app = Flask(__name__)
        app.secret_key = "demo-secret-change-in-production"
        
        from production_integration import ProductionIntegrator, create_landing_page_route
        
        integrator = ProductionIntegrator()
        integrator.init_app(app)
        create_landing_page_route(app)
        
        @app.route('/')
        def demo_home():
            from flask import request
            license_info = getattr(request, 'license_info', None)
            
            if license_info:
                return f'''
                <div style="font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px;">
                    <h1>üéâ AgriWeb 2.0 - Mode Production</h1>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <h3>‚úÖ Licence Active</h3>
                        <p><strong>Type :</strong> {license_info["license_type"].title()}</p>
                        <p><strong>Email :</strong> {license_info["email"]}</p>
                        <p><strong>Expire le :</strong> {license_info["expires_at"].strftime("%d/%m/%Y")}</p>
                    </div>
                    
                    <h3>üîß Fonctionnalit√©s disponibles :</h3>
                    <ul>
                        <li>‚úÖ Syst√®me de licences op√©rationnel</li>
                        <li>‚úÖ Essai gratuit 7 jours</li>
                        <li>‚úÖ Paiements Stripe int√©gr√©s</li>
                        <li>‚úÖ Protection par licence</li>
                        <li>‚ö†Ô∏è Application principale √† connecter</li>
                    </ul>
                    
                    <div style="margin: 30px 0;">
                        <a href="/pricing" style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
                            üìã Voir les tarifs
                        </a>
                        <a href="/production/status" style="background: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin-left: 10px;">
                            üìä Status syst√®me
                        </a>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <strong>üí° Pour activer votre application AgriWeb compl√®te :</strong><br>
                        1. Assurez-vous que agriweb_source.py est accessible<br>
                        2. Relancez le d√©ploiement<br>
                        3. Votre application sera automatiquement prot√©g√©e par licences
                    </div>
                </div>
                '''
            else:
                return '<script>window.location="/landing"</script>'
        
        return app
    
    def generate_deployment_files(self):
        """G√©n√®re les fichiers de configuration pour le d√©ploiement"""
        
        print("üìÑ G√©n√©ration des fichiers de d√©ploiement...")
        
        # 1. Fichier requirements.txt
        requirements_content = '''Flask==2.3.3
stripe==6.0.0
psycopg2-binary==2.9.7
requests==2.31.0
PyYAML==6.0.1
python-dotenv==1.0.0
gunicorn==21.2.0
folium==0.14.0
geopandas==0.13.2
shapely==2.0.1
pyproj==3.6.0
'''
        
        with open("requirements_production.txt", "w") as f:
            f.write(requirements_content)
        
        # 2. Fichier de configuration environnement
        env_content = '''# Configuration de production AgriWeb 2.0
# IMPORTANT: Modifiez ces valeurs pour votre environnement

# Application
FLASK_ENV=production
SECRET_KEY=your-super-secret-key-change-this
DEBUG=False

# Base de donn√©es
DATABASE_URL=postgresql://user:password@localhost/agriweb_prod

# GeoServer
GEOSERVER_URL=http://localhost:8080/geoserver
GEOSERVER_USER=admin
GEOSERVER_PASSWORD=your-geoserver-password

# Stripe (mode production)
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# Email (pour notifications)
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@domain.com
SMTP_PASSWORD=your-email-password

# Domaine de production
DOMAIN=https://your-domain.com
'''
        
        with open(".env.production", "w") as f:
            f.write(env_content)
        
        # 3. Script de d√©marrage
        startup_script = '''#!/bin/bash
# Script de d√©marrage pour AgriWeb 2.0 en production

echo "üöÄ D√©marrage d'AgriWeb 2.0..."

# Chargement des variables d'environnement
source .env.production

# D√©marrage avec Gunicorn
gunicorn -w 4 -b 0.0.0.0:5000 --timeout 120 --log-level info complete_production_deployment:app

echo "‚úÖ AgriWeb 2.0 d√©marr√© sur le port 5000"
'''
        
        with open("start_production.sh", "w") as f:
            f.write(startup_script)
        
        # Rendre le script ex√©cutable
        os.chmod("start_production.sh", 0o755)
        
        # 4. Configuration Docker (optionnel)
        dockerfile_content = '''FROM python:3.9-slim

WORKDIR /app

# Installation des d√©pendances syst√®me
RUN apt-get update && apt-get install -y \\
    postgresql-client \\
    && rm -rf /var/lib/apt/lists/*

# Copie des fichiers
COPY requirements_production.txt .
COPY . .

# Installation des d√©pendances Python
RUN pip install -r requirements_production.txt

# Port d'exposition
EXPOSE 5000

# Commande de d√©marrage
CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "complete_production_deployment:app"]
'''
        
        with open("Dockerfile", "w") as f:
            f.write(dockerfile_content)
        
        print("  ‚úÖ requirements_production.txt")
        print("  ‚úÖ .env.production")
        print("  ‚úÖ start_production.sh")
        print("  ‚úÖ Dockerfile")
    
    def create_complete_app_file(self):
        """Cr√©e le fichier principal d'application pour la production"""
        
        app_content = '''#!/usr/bin/env python3
"""
üöÄ AGRIWEB 2.0 - APPLICATION DE PRODUCTION COMPL√àTE
Point d'entr√©e principal avec toutes les fonctionnalit√©s
"""

import os
from dotenv import load_dotenv

# Chargement des variables d'environnement
load_dotenv('.env.production')

# Import et configuration de l'application
from complete_production_deployment import AgriWebProductionDeployer

def create_app():
    """Factory pour cr√©er l'application de production"""
    deployer = AgriWebProductionDeployer()
    
    # V√©rifications et setup
    if not deployer.check_requirements():
        raise Exception("Pr√©requis non satisfaits")
    
    deployer.setup_production_database()
    app = deployer.create_production_app()
    
    return app

# Application principale
app = create_app()

if __name__ == "__main__":
    print("üöÄ AgriWeb 2.0 - Mode Production")
    print("   Port: 5000")
    print("   URL: http://localhost:5000")
    app.run(host="0.0.0.0", port=5000, debug=False)
'''
        
        with open("app_production.py", "w") as f:
            f.write(app_content)
        
        print("  ‚úÖ app_production.py cr√©√©")
    
    def run_deployment(self):
        """Lance le d√©ploiement complet"""
        
        print("üöÄ D√âPLOIEMENT AGRIWEB 2.0 EN PRODUCTION")
        print("=" * 60)
        
        # 1. V√©rifications
        if not self.check_requirements():
            return False
        
        # 2. Configuration base de donn√©es
        self.setup_production_database()
        
        # 3. G√©n√©ration des fichiers
        self.generate_deployment_files()
        self.create_complete_app_file()
        
        # 4. Configuration GeoServer
        print("üåê Configuration GeoServer...")
        geoserver_helper = GeoServerDeploymentHelper()
        geoserver_helper.setup_production_environment()
        
        # 5. Cr√©ation de l'application
        app = self.create_production_app()
        
        # 6. Sauvegarde de la configuration
        self.save_deployment_config()
        
        print("\nüéâ D√âPLOIEMENT TERMIN√â AVEC SUCC√àS !")
        print("=" * 60)
        
        self.display_deployment_summary()
        
        return app
    
    def save_deployment_config(self):
        """Sauvegarde la configuration de d√©ploiement"""
        
        config_file = "deployment_config.yaml"
        
        with open(config_file, "w") as f:
            yaml.dump(self.deployment_config, f, default_flow_style=False)
        
        print(f"  ‚úÖ Configuration sauvegard√©e : {config_file}")
    
    def display_deployment_summary(self):
        """Affiche le r√©sum√© du d√©ploiement"""
        
        print("""
üìã R√âSUM√â DU D√âPLOIEMENT
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üéØ FONCTIONNALIT√âS ACTIVES :
   ‚úÖ Essai gratuit 7 jours automatique
   ‚úÖ Gestion compl√®te des licences (Basic, Pro, Enterprise)
   ‚úÖ Paiements s√©curis√©s avec Stripe
   ‚úÖ Protection par licence de toutes les fonctionnalit√©s
   ‚úÖ Adaptation GeoServer selon le type de licence
   ‚úÖ Interface de tarification professionnelle
   ‚úÖ Syst√®me de renouvellement automatique

üîß FICHIERS G√âN√âR√âS :
   üìÑ requirements_production.txt - D√©pendances Python
   üìÑ .env.production - Variables d'environnement
   üìÑ app_production.py - Application principale
   üìÑ start_production.sh - Script de d√©marrage
   üìÑ Dockerfile - Configuration Docker
   üìÑ production_geoserver_config.yaml - Config GeoServer
   üìÑ DEPLOYMENT_GUIDE.md - Guide de d√©ploiement complet

üåê URLS IMPORTANTES :
   üè† Page d'accueil : http://localhost:5000/
   üÜì Essai gratuit : http://localhost:5000/landing
   üí≥ Tarification : http://localhost:5000/pricing
   üìä Status syst√®me : http://localhost:5000/production/status
   üîß API licences : http://localhost:5000/api/license/validate

üí° PROCHAINES √âTAPES :

1. CONFIGURATION STRIPE :
   - Cr√©ez un compte Stripe (https://stripe.com)
   - R√©cup√©rez vos cl√©s API (test puis production)
   - Configurez les webhooks pour les renouvellements
   - Modifiez .env.production avec vos vraies cl√©s

2. GEOSERVER PRODUCTION :
   - D√©ployez GeoServer sur votre serveur
   - Importez vos donn√©es g√©ographiques
   - Configurez les couches selon le guide
   - Adaptez l'URL dans production_geoserver_config.yaml

3. H√âBERGEMENT :
   - Choisissez un h√©bergeur (AWS, OVH, DigitalOcean...)
   - Configurez votre nom de domaine
   - D√©ployez avec Docker ou directement
   - Configurez HTTPS avec Let's Encrypt

4. TESTS :
   - Testez l'inscription essai gratuit
   - V√©rifiez les paiements en mode test
   - Validez toutes les fonctionnalit√©s avec licences
   - Effectuez des tests de charge

üöÄ D√âMARRAGE RAPIDE :
   
   Mode d√©veloppement :
   python complete_production_deployment.py
   
   Mode production :
   ./start_production.sh
   
   Avec Docker :
   docker build -t agriweb2.0 .
   docker run -p 5000:5000 agriweb2.0

üí∞ MOD√àLE √âCONOMIQUE ACTIV√â :
   üÜì Essai : 7 jours gratuits, 10 communes max
   üíº Basic : 299‚Ç¨/an, 100 communes, 500 rapports/jour
   üöÄ Pro : 999‚Ç¨/an, 1000 communes, API compl√®te
   üè¢ Enterprise : 2999‚Ç¨/an, illimit√©, GeoServer d√©di√©

üéâ Votre syst√®me AgriWeb 2.0 est pr√™t pour la commercialisation !
   Consultez DEPLOYMENT_GUIDE.md pour les d√©tails techniques.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
""")

def main():
    """Point d'entr√©e principal du d√©ploiement"""
    
    print("üöÄ Initialisation du d√©ploiement AgriWeb 2.0...")
    
    deployer = AgriWebProductionDeployer()
    app = deployer.run_deployment()
    
    if app:
        print("\nüéÆ Lancement du serveur de production...")
        app.run(host="127.0.0.1", port=5000, debug=False)
    else:
        print("‚ùå √âchec du d√©ploiement")
        sys.exit(1)

# Point d'entr√©e pour Gunicorn
app = None

def get_app():
    """Fonction pour obtenir l'app (utilis√©e par Gunicorn)"""
    global app
    if app is None:
        deployer = AgriWebProductionDeployer()
        app = deployer.run_deployment()
    return app

# Pour l'import direct
app = get_app()

if __name__ == "__main__":
    main()
