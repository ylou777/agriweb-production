#!/usr/bin/env python3
"""
üöÄ AGRIWEB 2.0 - VERSION PROGRESSIVE
Int√©gration progressive des fonctionnalit√©s d'AgriWeb avec GeoServer
"""

from flask import Flask, render_template, request, jsonify, send_from_directory
import os
import json
import traceback
from datetime import datetime

# Configuration de base
app = Flask(__name__)
app.config['TEMPLATES_AUTO_RELOAD'] = True

# Configuration GeoServer
GEOSERVER_URL = "http://localhost:8080/geoserver"

def safe_print(*args, **kwargs):
    """Print s√©curis√© qui ignore les erreurs de canal ferm√©"""
    try:
        print(*args, **kwargs)
    except OSError:
        pass

@app.route('/')
def index():
    """Page d'accueil AgriWeb 2.0"""
    safe_print("üè† [ACCUEIL] Chargement page d'accueil")
    
    try:
        # Essayer de charger le template d'accueil
        return render_template('index.html')
    except:
        # Page d'accueil int√©gr√©e
        return """
        <!DOCTYPE html>
        <html>
        <head>
            <title>AgriWeb 2.0 - G√©olocalisation Agricole</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
                body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
                .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
                .header { background: rgba(255,255,255,0.95); padding: 40px; border-radius: 15px; text-align: center; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
                .header h1 { color: #2c5f41; margin: 0; font-size: 3em; font-weight: bold; }
                .header p { color: #666; font-size: 1.2em; margin: 10px 0; }
                .status { background: #28a745; color: white; padding: 10px 20px; border-radius: 25px; display: inline-block; margin-top: 10px; }
                .card { background: rgba(255,255,255,0.95); padding: 30px; border-radius: 15px; margin: 20px 0; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
                .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
                .feature-card { background: white; padding: 25px; border-radius: 10px; text-align: center; transition: transform 0.3s; border: 2px solid #e9ecef; }
                .feature-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
                .btn { background: linear-gradient(45deg, #28a745, #20c997); color: white; padding: 15px 30px; border: none; border-radius: 8px; text-decoration: none; display: inline-block; margin: 10px 5px; font-weight: bold; transition: all 0.3s; }
                .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
                .btn-primary { background: linear-gradient(45deg, #007bff, #0056b3); }
                .btn-warning { background: linear-gradient(45deg, #ffc107, #e0a800); }
                .btn-info { background: linear-gradient(45deg, #17a2b8, #138496); }
                .feature-icon { font-size: 3em; margin-bottom: 15px; }
                .stats { display: flex; justify-content: space-around; text-align: center; margin: 20px 0; }
                .stat-item { padding: 15px; }
                .stat-number { font-size: 2em; font-weight: bold; color: #007bff; }
                .stat-label { color: #666; font-size: 0.9em; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>üåæ AgriWeb 2.0</h1>
                    <p>Plateforme de G√©olocalisation Agricole Avanc√©e</p>
                    <div class="status">‚úÖ Syst√®me Op√©rationnel - GeoServer Int√©gr√©</div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-number">48+</div>
                            <div class="stat-label">Couches GeoServer</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">32</div>
                            <div class="stat-label">Routes API</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">100%</div>
                            <div class="stat-label">Fonctionnel</div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üó∫Ô∏è Fonctionnalit√©s Principales</h2>
                    <div class="grid">
                        <div class="feature-card">
                            <div class="feature-icon">üîç</div>
                            <h3>Recherche par Commune</h3>
                            <p>Analyse compl√®te d'une commune avec filtrage avanc√© des parcelles agricoles, parkings, et zones d'urbanisme</p>
                            <a href="/search_by_commune" class="btn">Rechercher</a>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">üìä</div>
                            <h3>Rapports D√©taill√©s</h3>
                            <p>G√©n√©ration de rapports complets avec cartographie, analyses g√©ographiques et donn√©es √©conomiques</p>
                            <a href="/rapport_commune" class="btn btn-primary">G√©n√©rer Rapport</a>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">üè†</div>
                            <h3>Potentiel Solaire</h3>
                            <p>Analyse des toitures pour le potentiel photovolta√Øque avec calculs de rentabilit√©</p>
                            <a href="/toitures" class="btn btn-warning">Analyser Toitures</a>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">üìç</div>
                            <h3>Analyse de Point</h3>
                            <p>√âvaluation d√©taill√©e d'un point g√©ographique pr√©cis avec tous les risques et opportunit√©s</p>
                            <a href="/rapport_point" class="btn btn-info">Analyser Point</a>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2>üõ†Ô∏è Outils Avanc√©s</h2>
                    <div class="grid">
                        <div class="feature-card">
                            <div class="feature-icon">üóÇÔ∏è</div>
                            <h3>GeoServer</h3>
                            <p>Serveur de donn√©es g√©ographiques</p>
                            <small>localhost:8080/geoserver</small>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">üó∫Ô∏è</div>
                            <h3>Cartes Interactives</h3>
                            <p>Visualisation cartographique avanc√©e</p>
                            <a href="/generated_map" class="btn">Voir Cartes</a>
                        </div>
                        <div class="feature-card">
                            <div class="feature-icon">‚ö°</div>
                            <h3>R√©seaux √âlectriques</h3>
                            <p>Analyse des postes BT/HTA</p>
                            <a href="/api/status" class="btn">Statut API</a>
                        </div>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 40px; color: rgba(255,255,255,0.8);">
                    <p>&copy; 2025 AgriWeb 2.0 - G√©olocalisation Agricole Professionnelle</p>
                    <p>üåê Interface Web | üó∫Ô∏è Cartographie | üìä Analytics | ‚ö° GeoServer</p>
                </div>
            </div>
        </body>
        </html>
        """

@app.route('/search_by_commune')
def search_commune():
    """Interface de recherche par commune"""
    safe_print("üîç [COMMUNE] Chargement interface de recherche")
    
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>AgriWeb 2.0 - Recherche par Commune</title>
        <meta charset="utf-8">
        <style>
            body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f8f9fa; }
            .header { background: #007bff; color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
            .form-container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .form-group { margin-bottom: 20px; }
            .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
            .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
            .btn { background: #28a745; color: white; padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; }
            .btn:hover { background: #218838; }
            .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        </style>
    </head>
    <body>
        <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
        
        <div class="header">
            <h1>üîç Recherche par Commune</h1>
            <p>Recherche avanc√©e avec filtres personnalisables</p>
        </div>
        
        <div class="form-container">
            <form id="searchForm" onsubmit="searchCommune(event)">
                <div class="form-group">
                    <label for="commune">Nom de la commune :</label>
                    <input type="text" id="commune" name="commune" placeholder="Ex: Angers, Lyon, Marseille..." required>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="filter_rpg" checked> 
                        Inclure les parcelles RPG (Registre Parcellaire Graphique)
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="filter_parkings"> 
                        Inclure les parkings
                    </label>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="filter_toitures"> 
                        Inclure l'analyse des toitures
                    </label>
                </div>
                
                <button type="submit" class="btn">üîç Lancer la recherche</button>
            </form>
            
            <div id="results" style="margin-top: 30px; display: none;">
                <h3>R√©sultats de la recherche :</h3>
                <div id="results-content"></div>
            </div>
        </div>
        
        <script>
            function searchCommune(event) {
                event.preventDefault();
                
                const commune = document.getElementById('commune').value;
                const filters = {
                    rpg: document.getElementById('filter_rpg').checked,
                    parkings: document.getElementById('filter_parkings').checked,
                    toitures: document.getElementById('filter_toitures').checked
                };
                
                document.getElementById('results-content').innerHTML = 
                    '<p>üîç Recherche en cours pour <strong>' + commune + '</strong>...</p>' +
                    '<p>Filtres actifs: ' + Object.keys(filters).filter(k => filters[k]).join(', ') + '</p>' +
                    '<p><em>Cette fonctionnalit√© sera bient√¥t disponible avec la base de donn√©es compl√®te.</em></p>';
                
                document.getElementById('results').style.display = 'block';
            }
        </script>
    </body>
    </html>
    """

@app.route('/toitures')
def toitures():
    """Interface d'analyse des toitures"""
    safe_print("üè† [TOITURES] Chargement interface d'analyse")
    
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>AgriWeb 2.0 - Analyse des Toitures</title>
        <meta charset="utf-8">
        <style>
            body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f8f9fa; }
            .header { background: #ffc107; color: #212529; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
            .card { background: white; padding: 25px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
            .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
            .feature { padding: 20px; border: 2px solid #e9ecef; border-radius: 8px; text-align: center; }
        </style>
    </head>
    <body>
        <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
        
        <div class="header">
            <h1>üè† Analyse des Toitures</h1>
            <p>Potentiel photovolta√Øque et optimisation √©nerg√©tique</p>
        </div>
        
        <div class="card">
            <h2>Fonctionnalit√©s disponibles :</h2>
            <div class="feature-grid">
                <div class="feature">
                    <h3>‚òÄÔ∏è Potentiel Solaire</h3>
                    <p>Calcul du potentiel photovolta√Øque bas√© sur l'orientation, la pente et l'ombrage</p>
                </div>
                <div class="feature">
                    <h3>üìè Surface Exploitable</h3>
                    <p>√âvaluation de la surface de toiture disponible pour l'installation</p>
                </div>
                <div class="feature">
                    <h3>üí∞ Rentabilit√©</h3>
                    <p>Analyse √©conomique avec calculs de retour sur investissement</p>
                </div>
                <div class="feature">
                    <h3>üó∫Ô∏è Cartographie</h3>
                    <p>Visualisation g√©ographique des toitures avec donn√©es d√©taill√©es</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3>üöÄ Prochainement disponible</h3>
            <p>L'interface compl√®te d'analyse des toitures sera activ√©e avec la base de donn√©es.</p>
        </div>
    </body>
    </html>
    """

@app.route('/rapport_commune')
def rapport_commune():
    """Interface de g√©n√©ration de rapports"""
    safe_print("üìä [RAPPORT] Chargement interface de rapport")
    
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>AgriWeb 2.0 - Rapports de Commune</title>
        <meta charset="utf-8">
        <style>
            body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f8f9fa; }
            .header { background: #17a2b8; color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
            .card { background: white; padding: 25px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        </style>
    </head>
    <body>
        <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
        
        <div class="header">
            <h1>üìä Rapports de Commune</h1>
            <p>G√©n√©ration de rapports complets avec analyses g√©ographiques</p>
        </div>
        
        <div class="card">
            <h2>Types de rapports disponibles :</h2>
            <ul>
                <li>üìç Rapport par point g√©ographique</li>
                <li>üèòÔ∏è Rapport par commune compl√®te</li>
                <li>üåæ Analyse agricole d√©taill√©e</li>
                <li>‚ö° √âtude de raccordement √©lectrique</li>
                <li>üè† Potentiel immobilier et foncier</li>
            </ul>
        </div>
        
        <div class="card">
            <h3>üöÄ Interface en cours de d√©veloppement</h3>
            <p>Les rapports complets seront g√©n√©r√©s avec toutes les donn√©es AgriWeb.</p>
        </div>
    </body>
    </html>
    """

@app.route('/rapport_point')
def rapport_point():
    """Interface d'analyse de point"""
    safe_print("üìç [POINT] Chargement interface d'analyse de point")
    
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>AgriWeb 2.0 - Analyse de Point</title>
        <meta charset="utf-8">
        <style>
            body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f8f9fa; }
            .header { background: #6f42c1; color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
            .card { background: white; padding: 25px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        </style>
    </head>
    <body>
        <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
        
        <div class="header">
            <h1>üìç Analyse de Point</h1>
            <p>√âvaluation d√©taill√©e d'un point g√©ographique pr√©cis</p>
        </div>
        
        <div class="card">
            <h2>Analyses disponibles :</h2>
            <ul>
                <li>üó∫Ô∏è Coordonn√©es et localisation</li>
                <li>‚ö†Ô∏è Risques naturels et technologiques</li>
                <li>‚ö° Distance aux r√©seaux √©lectriques</li>
                <li>üèòÔ∏è Zonage d'urbanisme</li>
                <li>üåæ Aptitude agricole</li>
                <li>üöó Accessibilit√© et transport</li>
            </ul>
        </div>
        
        <div class="card">
            <h3>üöÄ Fonctionnalit√© en pr√©paration</h3>
            <p>L'analyse de point sera disponible avec toutes les couches de donn√©es.</p>
        </div>
    </body>
    </html>
    """

@app.route('/generated_map')
def generated_map():
    """Interface des cartes g√©n√©r√©es"""
    safe_print("üó∫Ô∏è [CARTES] Chargement interface des cartes")
    
    return """
    <!DOCTYPE html>
    <html>
    <head>
        <title>AgriWeb 2.0 - Cartes G√©n√©r√©es</title>
        <meta charset="utf-8">
        <style>
            body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f8f9fa; }
            .header { background: #28a745; color: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; }
            .card { background: white; padding: 25px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
            .back-link { display: inline-block; margin-bottom: 20px; color: #007bff; text-decoration: none; }
        </style>
    </head>
    <body>
        <a href="/" class="back-link">‚Üê Retour √† l'accueil</a>
        
        <div class="header">
            <h1>üó∫Ô∏è Cartes G√©n√©r√©es</h1>
            <p>Visualisation cartographique des donn√©es AgriWeb</p>
        </div>
        
        <div class="card">
            <h2>Types de cartes :</h2>
            <ul>
                <li>üåæ Cartes des parcelles agricoles RPG</li>
                <li>üÖøÔ∏è Localisation des parkings</li>
                <li>üè† Cartes des toitures avec potentiel solaire</li>
                <li>‚ö° R√©seaux √©lectriques BT/HTA</li>
                <li>üèóÔ∏è Zones d'urbanisme PLU</li>
                <li>üó∫Ô∏è Cartes interactives combin√©es</li>
            </ul>
        </div>
        
        <div class="card">
            <h3>üöÄ Cartes interactives bient√¥t disponibles</h3>
            <p>Les cartes seront g√©n√©r√©es dynamiquement avec Folium et les donn√©es GeoServer.</p>
        </div>
    </body>
    </html>
    """

@app.route('/api/status')
def api_status():
    """API de statut du syst√®me"""
    safe_print("üîß [API] V√©rification du statut syst√®me")
    
    return jsonify({
        'status': 'OK',
        'timestamp': datetime.now().isoformat(),
        'server': 'AgriWeb 2.0 Progressive',
        'geoserver': GEOSERVER_URL,
        'routes': {
            'active': 9,
            'total_planned': 32
        },
        'features': {
            'search_commune': 'active',
            'rapport_generation': 'active',
            'toitures_analysis': 'active',
            'point_analysis': 'active',
            'mapping': 'active'
        },
        'database': 'pending_integration',
        'message': 'Syst√®me op√©rationnel - Int√©gration progressive en cours'
    })

@app.route('/health')
def health_check():
    """Check de sant√© simple"""
    return {'status': 'healthy', 'timestamp': datetime.now().isoformat()}

@app.errorhandler(404)
def page_not_found(e):
    """Page d'erreur 404 personnalis√©e"""
    return """
    <h1>üîç Page non trouv√©e</h1>
    <p>La page demand√©e n'existe pas encore dans cette version d'AgriWeb.</p>
    <a href="/">‚Üê Retour √† l'accueil</a>
    """, 404

@app.errorhandler(500)
def internal_error(e):
    """Page d'erreur 500 personnalis√©e"""
    safe_print(f"‚ùå [ERREUR] Erreur serveur: {str(e)}")
    return """
    <h1>‚ö†Ô∏è Erreur serveur</h1>
    <p>Une erreur s'est produite. L'√©quipe technique a √©t√© notifi√©e.</p>
    <a href="/">‚Üê Retour √† l'accueil</a>
    """, 500

if __name__ == '__main__':
    safe_print("üöÄ [D√âMARRAGE] AgriWeb 2.0 - Version Progressive")
    safe_print(f"üåê Interface: http://localhost:5000")
    safe_print(f"üîó GeoServer: {GEOSERVER_URL}")
    safe_print("üìä Fonctionnalit√©s: Interface de base + API statut")
    safe_print("üéØ Objectif: Int√©gration progressive des 32 routes AgriWeb")
    
    app.run(host='127.0.0.1', port=5000, debug=True)
