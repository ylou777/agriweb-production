<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üó∫Ô∏è Carte Interactive AgriWeb 2.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; }
        
        /* Interface de contr√¥le des couches avanc√©e */
        .advanced-layer-control {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .control-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .control-body {
            padding: 15px;
        }
        
        .layer-group {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .layer-group-header {
            background: #f8f9fa;
            padding: 12px 15px;
            font-weight: 600;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: between;
        }
        
        .layer-group-header:hover {
            background: #e9ecef;
        }
        
        .layer-group-body {
            padding: 10px;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        
        .layer-item:last-child {
            border-bottom: none;
        }
        
        .layer-checkbox {
            margin-right: 10px;
        }
        
        .layer-name {
            flex: 1;
            font-size: 14px;
            color: #333;
        }
        
        .layer-opacity {
            width: 60px;
            margin-left: 10px;
        }
        
        .layer-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        
        .layer-action-btn {
            background: none;
            border: none;
            color: #6c757d;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .layer-action-btn:hover {
            background: #e9ecef;
            color: #495057;
        }
        
        /* Outils de dessin */
        .drawing-tools {
            position: absolute;
            top: 10px;
            left: 60px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            padding: 8px;
        }
        
        .draw-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 8px 10px;
            margin: 2px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: inline-block;
        }
        
        .draw-btn:hover {
            background: #f8f9fa;
            border-color: #007bff;
        }
        
        .draw-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        
        /* Interface de recherche rapide */
        .search-control {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 300px;
            z-index: 1000;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: none;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        
        .search-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #007bff;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            color: white;
            cursor: pointer;
        }
        
        /* Pop-up am√©lior√© */
        .custom-popup {
            min-width: 300px;
        }
        
        .popup-header {
            background: #007bff;
            color: white;
            padding: 10px 15px;
            margin: -10px -15px 10px -15px;
            font-weight: 600;
        }
        
        .popup-content {
            line-height: 1.5;
        }
        
        .popup-actions {
            margin-top: 10px;
            text-align: center;
        }
        
        .popup-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin: 0 3px;
        }
        
        .popup-btn:hover {
            background: #218838;
        }
        
        /* Indicateur de chargement */
        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 2000;
            display: none;
        }
        
        /* Responsivit√© */
        @media (max-width: 768px) {
            .advanced-layer-control {
                width: 90%;
                right: 5%;
                top: 60px;
                max-height: 60vh;
            }
            
            .search-control {
                width: 250px;
            }
            
            .drawing-tools {
                left: 10px;
                top: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- Indicateur de chargement -->
    <div id="loading" class="loading-indicator">
        <i class="fas fa-spinner fa-spin"></i> Chargement des donn√©es...
    </div>
    
    <!-- Contr√¥le de recherche -->
    <div class="search-control">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç Rechercher une adresse, commune...">
        <button id="searchBtn" class="search-btn">
            <i class="fas fa-search"></i>
        </button>
    </div>
    
    <!-- Outils de dessin -->
    <div class="drawing-tools">
        <button class="draw-btn" id="drawPoint" title="Dessiner un point">
            <i class="fas fa-map-marker-alt"></i>
        </button>
        <button class="draw-btn" id="drawLine" title="Dessiner une ligne">
            <i class="fas fa-minus"></i>
        </button>
        <button class="draw-btn" id="drawPolygon" title="Dessiner un polygone">
            <i class="fas fa-draw-polygon"></i>
        </button>
        <button class="draw-btn" id="drawCircle" title="Dessiner un cercle">
            <i class="fas fa-circle"></i>
        </button>
        <button class="draw-btn" id="clearDrawings" title="Effacer les dessins">
            <i class="fas fa-trash"></i>
        </button>
    </div>
    
    <!-- Contr√¥le avanc√© des couches -->
    <div class="advanced-layer-control">
        <div class="control-header">
            <div>
                <i class="fas fa-layer-group"></i> Gestionnaire de Couches
            </div>
            <button id="toggleControl" style="background: none; border: none; color: white;">
                <i class="fas fa-chevron-up"></i>
            </button>
        </div>
        <div class="control-body">
            <!-- Couches de base -->
            <div class="layer-group">
                <div class="layer-group-header">
                    <i class="fas fa-map"></i> Fonds de carte
                </div>
                <div class="layer-group-body">
                    <div class="layer-item">
                        <input type="radio" name="baseLayer" value="osm" class="layer-checkbox" checked>
                        <span class="layer-name">OpenStreetMap</span>
                    </div>
                    <div class="layer-item">
                        <input type="radio" name="baseLayer" value="satellite" class="layer-checkbox">
                        <span class="layer-name">Vue satellite</span>
                    </div>
                    <div class="layer-item">
                        <input type="radio" name="baseLayer" value="terrain" class="layer-checkbox">
                        <span class="layer-name">Relief</span>
                    </div>
                </div>
            </div>
            
            <!-- Couches th√©matiques -->
            <div class="layer-group">
                <div class="layer-group-header">
                    <i class="fas fa-seedling"></i> Agriculture
                </div>
                <div class="layer-group-body">
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" data-layer="rpg">
                        <span class="layer-name">Registre Parcellaire</span>
                        <input type="range" class="layer-opacity" min="0" max="100" value="70">
                        <div class="layer-actions">
                            <button class="layer-action-btn" title="Info"><i class="fas fa-info"></i></button>
                            <button class="layer-action-btn" title="L√©gende"><i class="fas fa-palette"></i></button>
                        </div>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" data-layer="elevage">
                        <span class="layer-name">√âlevages</span>
                        <input type="range" class="layer-opacity" min="0" max="100" value="80">
                        <div class="layer-actions">
                            <button class="layer-action-btn" title="Info"><i class="fas fa-info"></i></button>
                            <button class="layer-action-btn" title="L√©gende"><i class="fas fa-palette"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Infrastructure -->
            <div class="layer-group">
                <div class="layer-group-header">
                    <i class="fas fa-bolt"></i> Infrastructure
                </div>
                <div class="layer-group-body">
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" data-layer="postes_bt">
                        <span class="layer-name">Postes BT</span>
                        <input type="range" class="layer-opacity" min="0" max="100" value="90">
                        <div class="layer-actions">
                            <button class="layer-action-btn" title="Info"><i class="fas fa-info"></i></button>
                            <button class="layer-action-btn" title="L√©gende"><i class="fas fa-palette"></i></button>
                        </div>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" data-layer="postes_hta">
                        <span class="layer-name">Postes HTA</span>
                        <input type="range" class="layer-opacity" min="0" max="100" value="90">
                        <div class="layer-actions">
                            <button class="layer-action-btn" title="Info"><i class="fas fa-info"></i></button>
                            <button class="layer-action-btn" title="L√©gende"><i class="fas fa-palette"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contraintes -->
            <div class="layer-group">
                <div class="layer-group-header">
                    <i class="fas fa-exclamation-triangle"></i> Contraintes
                </div>
                <div class="layer-group-body">
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" data-layer="zones_protegees">
                        <span class="layer-name">Zones prot√©g√©es</span>
                        <input type="range" class="layer-opacity" min="0" max="100" value="60">
                        <div class="layer-actions">
                            <button class="layer-action-btn" title="Info"><i class="fas fa-info"></i></button>
                            <button class="layer-action-btn" title="L√©gende"><i class="fas fa-palette"></i></button>
                        </div>
                    </div>
                    <div class="layer-item">
                        <input type="checkbox" class="layer-checkbox" data-layer="risques">
                        <span class="layer-name">Zones √† risques</span>
                        <input type="range" class="layer-opacity" min="0" max="100" value="70">
                        <div class="layer-actions">
                            <button class="layer-action-btn" title="Info"><i class="fas fa-info"></i></button>
                            <button class="layer-action-btn" title="L√©gende"><i class="fas fa-palette"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Carte principale -->
    <div id="map"></div>
    
    <script>
        // Initialisation de la carte
        const map = L.map('map').setView([46.603354, 1.888334], 6);
        
        // Fonds de carte
        const baseLayers = {
            osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '¬© Esri'
            }),
            terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenTopoMap contributors'
            })
        };
        
        // Ajouter la couche par d√©faut
        baseLayers.osm.addTo(map);
        
        // Couches de donn√©es
        const dataLayers = {};
        
        // Configuration des couches GeoServer
        const layerConfigs = {
            rpg: {
                name: 'Registre Parcellaire Graphique',
                url: '/proxy/wms',
                layers: 'gpu:PARCELLES_GRAPHIQUES',
                format: 'image/png',
                transparent: true
            },
            elevage: {
                name: '√âtablissements d\'√©levage',
                url: '/proxy/wms',
                layers: 'gpu:GeolocalisationEtablissement_Sirene france',
                format: 'image/png',
                transparent: true
            },
            postes_bt: {
                name: 'Postes BT',
                url: '/proxy/wms',
                layers: 'gpu:POSTES_ELECTRIQUES_BT',
                format: 'image/png',
                transparent: true
            },
            postes_hta: {
                name: 'Postes HTA',
                url: '/proxy/wms',
                layers: 'gpu:POSTES_ELECTRIQUES_HTA',
                format: 'image/png',
                transparent: true
            },
            zones_protegees: {
                name: 'Zones prot√©g√©es',
                url: '/proxy/wms',
                layers: 'gpu:ZONE_NATURA2000',
                format: 'image/png',
                transparent: true
            },
            risques: {
                name: 'Zones √† risques',
                url: '/proxy/wms',
                layers: 'gpu:zones_risques',
                format: 'image/png',
                transparent: true
            }
        };
        
        // Gestionnaire des couches de base
        document.querySelectorAll('input[name="baseLayer"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Supprimer toutes les couches de base
                Object.values(baseLayers).forEach(layer => {
                    if (map.hasLayer(layer)) {
                        map.removeLayer(layer);
                    }
                });
                // Ajouter la nouvelle couche
                baseLayers[this.value].addTo(map);
            });
        });
        
        // Gestionnaire des couches th√©matiques
        document.querySelectorAll('.layer-checkbox[data-layer]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const layerId = this.dataset.layer;
                const config = layerConfigs[layerId];
                
                if (this.checked) {
                    // Ajouter la couche
                    if (!dataLayers[layerId]) {
                        dataLayers[layerId] = L.tileLayer.wms(config.url, {
                            layers: config.layers,
                            format: config.format,
                            transparent: config.transparent,
                            attribution: 'GeoServer - AgriWeb'
                        });
                    }
                    dataLayers[layerId].addTo(map);
                } else {
                    // Supprimer la couche
                    if (dataLayers[layerId] && map.hasLayer(dataLayers[layerId])) {
                        map.removeLayer(dataLayers[layerId]);
                    }
                }
            });
        });
        
        // Gestionnaire d'opacit√© des couches
        document.querySelectorAll('.layer-opacity').forEach(slider => {
            slider.addEventListener('input', function() {
                const layerItem = this.closest('.layer-item');
                const checkbox = layerItem.querySelector('.layer-checkbox[data-layer]');
                if (checkbox && checkbox.dataset.layer) {
                    const layerId = checkbox.dataset.layer;
                    if (dataLayers[layerId] && map.hasLayer(dataLayers[layerId])) {
                        dataLayers[layerId].setOpacity(this.value / 100);
                    }
                }
            });
        });
        
        // Outils de dessin
        let currentDrawingMode = null;
        const drawnItems = L.featureGroup().addTo(map);
        
        // Gestionnaires des outils de dessin
        document.getElementById('drawPoint').addEventListener('click', function() {
            setDrawingMode('point');
        });
        
        document.getElementById('drawLine').addEventListener('click', function() {
            setDrawingMode('line');
        });
        
        document.getElementById('drawPolygon').addEventListener('click', function() {
            setDrawingMode('polygon');
        });
        
        document.getElementById('drawCircle').addEventListener('click', function() {
            setDrawingMode('circle');
        });
        
        document.getElementById('clearDrawings').addEventListener('click', function() {
            drawnItems.clearLayers();
        });
        
        function setDrawingMode(mode) {
            // D√©sactiver le mode pr√©c√©dent
            document.querySelectorAll('.draw-btn').forEach(btn => btn.classList.remove('active'));
            
            // Activer le nouveau mode
            document.getElementById('draw' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active');
            currentDrawingMode = mode;
            
            // Changer le curseur
            map.getContainer().style.cursor = 'crosshair';
        }
        
        // Gestionnaire de clic pour le dessin
        map.on('click', function(e) {
            if (currentDrawingMode === 'point') {
                const marker = L.marker(e.latlng).addTo(drawnItems);
                marker.bindPopup('Point ajout√©<br>Coordonn√©es: ' + e.latlng.lat.toFixed(6) + ', ' + e.latlng.lng.toFixed(6));
            }
        });
        
        // Recherche g√©ographique
        document.getElementById('searchBtn').addEventListener('click', performSearch);
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') performSearch();
        });
        
        function performSearch() {
            const query = document.getElementById('searchInput').value;
            if (!query.trim()) return;
            
            showLoading();
            
            // Utiliser Nominatim pour la g√©olocalisation
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1&countrycodes=fr`)
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if (data && data.length > 0) {
                        const result = data[0];
                        const lat = parseFloat(result.lat);
                        const lon = parseFloat(result.lon);
                        
                        map.setView([lat, lon], 14);
                        
                        // Ajouter un marqueur temporaire
                        const marker = L.marker([lat, lon]).addTo(map);
                        marker.bindPopup(`
                            <div class="custom-popup">
                                <div class="popup-header">üìç ${result.display_name}</div>
                                <div class="popup-content">
                                    <strong>Coordonn√©es:</strong><br>
                                    Latitude: ${lat.toFixed(6)}<br>
                                    Longitude: ${lon.toFixed(6)}
                                </div>
                                <div class="popup-actions">
                                    <button class="popup-btn" onclick="generateReport(${lat}, ${lon})">
                                        üìä G√©n√©rer rapport
                                    </button>
                                </div>
                            </div>
                        `).openPopup();
                        
                        // Supprimer le marqueur apr√®s 10 secondes
                        setTimeout(() => {
                            map.removeLayer(marker);
                        }, 10000);
                    } else {
                        alert('Aucun r√©sultat trouv√© pour cette recherche');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Erreur de recherche:', error);
                    alert('Erreur lors de la recherche');
                });
        }
        
        // Fonction pour g√©n√©rer un rapport
        function generateReport(lat, lon) {
            window.open(`/rapport_point?lat=${lat}&lon=${lon}`, '_blank');
        }
        
        // Gestionnaire du clic sur la carte pour les rapports
        map.on('contextmenu', function(e) {
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            const popup = L.popup()
                .setLatLng(e.latlng)
                .setContent(`
                    <div class="custom-popup">
                        <div class="popup-header">üéØ Analyse de position</div>
                        <div class="popup-content">
                            <strong>Coordonn√©es:</strong><br>
                            ${lat.toFixed(6)}, ${lon.toFixed(6)}
                        </div>
                        <div class="popup-actions">
                            <button class="popup-btn" onclick="generateReport(${lat}, ${lon})">
                                üìä Rapport complet
                            </button>
                            <button class="popup-btn" onclick="centerMap(${lat}, ${lon})">
                                üéØ Centrer
                            </button>
                        </div>
                    </div>
                `)
                .openOn(map);
        });
        
        function centerMap(lat, lon) {
            map.setView([lat, lon], map.getZoom());
        }
        
        // Toggle du contr√¥le des couches
        document.getElementById('toggleControl').addEventListener('click', function() {
            const body = document.querySelector('.control-body');
            const icon = this.querySelector('i');
            
            if (body.style.display === 'none') {
                body.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                body.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        });
        
        // Fonctions utilitaires
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        // Initialisation termin√©e
        console.log('üó∫Ô∏è Carte AgriWeb 2.0 initialis√©e avec √©diteur de couches avanc√©');
    </script>
</body>
</html>