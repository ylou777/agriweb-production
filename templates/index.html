<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mon App Géo</title>
  <!-- Polices et styles externes -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    html, body {
      height: 100%;
      min-height: 100vh;
    }
    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .main-container {
      flex: 1 1 0;
      display: flex;
      min-height: 0;
      height: 100vh;
      overflow: hidden;
    }
    #sidebar {
      width: 340px;
      min-width: 320px;
      max-width: 450px;
      overflow-y: auto;
      background: #fff;
      z-index: 10;
      border-right: 1px solid #f1f1f1;
      height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    #mapFrame {
      flex: 1 1 0;
      width: 100%;
      height: 100vh;
      min-width: 0;
      border: none;
      display: block;
      background: #eee;
    }
    .layer-list {
      list-style: none;
      padding-left: 0;
      margin: 0 0 1em 0;
    }
    .layer-list li {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .layer-color {
      width: 14px;
      height: 14px;
      display: inline-block;
      border-radius: 4px;
      margin-right: 8px;
      border: 1px solid #bbb;
    }
    pre {
      background: #f0f0f0;
      padding: 1em;
      height: 200px;
      overflow: auto;
      font-size: .8rem;
    }
    .slider-value {
      font-weight: 500;
    }
    /* Responsive sidebar pour mobile */
    @media (max-width: 991px) {
      #sidebar {
        position: fixed !important;
        left: -100vw;
        top: 0;
        width: 90vw;
        max-width: 98vw;
        height: 100vh;
        z-index: 1050;
        box-shadow: 4px 0 24px #0002;
        transition: left 0.3s;
      }
      #sidebar.show {
        left: 0;
      }
      .main-container {
        padding-left: 0 !important;
      }
    }
    #closeSidebarBtn { display: none; }
    @media (max-width: 991px) {
      #closeSidebarBtn { display: inline-block; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-brand">Mon App Géo</span>
    <button id="openSidebarBtn" class="btn btn-outline-light d-lg-none ms-auto" type="button">Menu</button>
  </nav>
  <div class="main-container">
    <div id="sidebar" class="text-dark">
      <div class="offcanvas-header d-flex align-items-center px-3 pt-3">
        <h5 class="offcanvas-title flex-grow-1 mb-0">Panneau de recherche</h5>
        <button id="closeSidebarBtn" class="btn-close text-reset ms-2" type="button"></button>
      </div>
      <div class="offcanvas-body p-0">
        <div class="accordion" id="searchAccordion">
          {% include 'search_panel.html' %}
        </div>
        <hr class="m-0">
        <div class="p-3">
          <h6 class="fw-bold">Calques visibles</h6>
          <ul id="layerControlList" class="layer-list"></ul>
          <h6 class="fw-bold mt-4">Informations</h6>
          <div id="info-panel"></div>
          <button id="reportButton" type="button" class="btn btn-warning w-100 mt-2" onclick="generateReport()">Générer rapport (point courant)</button>
          <button id="communeReportBtn" type="button" class="btn btn-outline-primary w-100 mt-2">Générer rapport commune</button>
          <button id="deptReportCarteBtn" type="button" class="btn btn-outline-success w-100 mt-2">
            Générer rapport département (à partir de la carte)
          </button>
        </div>
      </div>
    </div>
    <iframe id="mapFrame" src="/static/map.html"></iframe>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/main.js"></script>
  <script>
    // Sidebar responsive (fixe desktop, offcanvas mobile)
    const sidebar = document.getElementById('sidebar');
    const openBtn = document.getElementById('openSidebarBtn');
    const closeBtn = document.getElementById('closeSidebarBtn');

    function openSidebar() {
      sidebar.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeSidebar() {
      sidebar.classList.remove('show');
      document.body.style.overflow = '';
    }
    if (openBtn) openBtn.addEventListener('click', openSidebar);
    if (closeBtn) closeBtn.addEventListener('click', closeSidebar);

    // Ferme sidebar sur clic extérieur (mobile uniquement)
    window.addEventListener('click', function(e) {
      if(window.innerWidth > 991) return;
      if(sidebar.classList.contains('show') && !sidebar.contains(e.target) && e.target !== openBtn) {
        closeSidebar();
      }
    });
    // Ferme la sidebar sur resize desktop
    window.addEventListener('resize', () => {
      if(window.innerWidth > 991) closeSidebar();
    });

    // Contrôle des calques depuis main.js
    function updateLayerSidebarControl(layers) {
      const list = document.getElementById("layerControlList");
      if (!list) return;
      list.innerHTML = '';
      Object.entries(layers).forEach(([key, config]) => {
        const li = document.createElement('li');
        const box = document.createElement('input');
        box.type = "checkbox";
        box.checked = true;
        box.dataset.layer = key;
        box.style.marginRight = "7px";
        box.onchange = function() {
          const m = document.getElementById("mapFrame").contentWindow;
          if (m && typeof m.toggleLayerVisibility === "function") {
            m.toggleLayerVisibility(key, box.checked);
          } else if (m && m.toggleLayerVisibility) {
            m.toggleLayerVisibility(key, box.checked);
          }
        };
        const color = document.createElement('span');
        color.className = 'layer-color';
        color.style.background = config.color || '#bbb';
        li.appendChild(box);
        li.appendChild(color);
        li.appendChild(document.createTextNode(config.label || key));
        list.appendChild(li);
      });
    }
    window.updateLayerSidebarControl = updateLayerSidebarControl;
  </script>
</body>
</html>
