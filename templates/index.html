<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mon App Géo</title>

  <!-- Google Fonts: Poppins -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
  />
  <!-- Bootstrap 5 CSS -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
  />
  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />

  <style>
    :root {
      --bs-primary:   #2B7a78;
      --bs-secondary: #3a506b;
      --bs-success:   #76cec4;
      --bs-info:      #5bc0be;
      --bs-warning:   #f4b860;
      --bs-danger:    #ca3c25;
      --bs-dark:      #0b2027;
    }
    html, body {
      height: 100%; margin: 0;
      font-family: 'Poppins', sans-serif;
    }
    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #sidebarOffcanvas {
      width: 320px;
    }
    #mapContainer {
      position: relative;
      flex: 1;
    }
    /* Folium iframe en dessous */
    #mapFrame {
      position: relative;
      z-index: 0;
      width: 100%;
      height: 100%;
      border: none;
    }
    /* Calque SSE Leaflet au-dessus */
    #mapSSE {
      position: absolute;
      top: 0; bottom: 0; left: 0; right: 0;
      z-index: 1;
    }
    #info-panel .card {
      margin-bottom: 1rem;
    }
    .search-form { display: none; }
    #ssePanel { display: none; }
  </style>
</head>
<body>
  <div id="app">
    <!-- Navbar -->
    <nav class="navbar navbar-dark bg-dark px-3">
      <a class="navbar-brand" href="#">Mon App Géo</a>
      <button
        class="btn btn-outline-light"
        data-bs-toggle="offcanvas"
        data-bs-target="#sidebarOffcanvas"
      >Menu</button>
    </nav>

    <div class="main-container">
      <!-- Sidebar -->
      <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">Panneau de Recherche</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body overflow-auto">

          <!-- Mode de recherche -->
          <div class="mb-4">
            <h6>Mode de recherche</h6>
            <div class="form-check">
              <input class="form-check-input search-mode" type="radio" name="search_mode" id="mode_address" value="address" checked>
              <label class="form-check-label" for="mode_address">Adresse</label>
            </div>
            <div class="form-check">
              <input class="form-check-input search-mode" type="radio" name="search_mode" id="mode_commune" value="commune">
              <label class="form-check-label" for="mode_commune">Commune</label>
            </div>
            <div class="form-check">
              <input class="form-check-input search-mode" type="radio" name="search_mode" id="mode_dept" value="department">
              <label class="form-check-label" for="mode_dept">Département</label>
            </div>
          </div>

          <!-- 1) Recherche par Département -->
          <div id="form_dept" class="search-form mb-4">
            <h6>Recherche par Département</h6>
            <div class="input-group">
              <input
                type="text"
                id="dept_input"
                class="form-control"
                placeholder="Ex : 23"
                maxlength="2"
              />
              <button
                id="deptSearchButton"
                class="btn btn-primary"
                type="button"
              >Lancer la recherche</button>
            </div>
          </div>

          <!-- 2) Recherche unifiée -->
          <div id="form_address" class="search-form mb-4">
          <form id="unifiedSearchForm">
            <h6>Recherche (Adresse / Coordonnées / GeoJSON)</h6>
            <input
              type="text"
              id="search_input"
              class="form-control mb-2"
              placeholder="3.137402,45.826511 ou {'type':'Point',...}"
              required
            />
            <input type="hidden" id="latitude" />
            <input type="hidden" id="longitude" />
            <input type="hidden" id="address" />

            <div class="mb-3">
              <label for="sirene_radius" class="form-label">Rayon Sirène (km)</label>
              <input
                type="range"
                id="sirene_radius"
                class="form-range"
                min="0" max="10" step="0.1"
                value="0.05"
              />
              <span id="sirene_radius_val" class="ms-2">0.05 km</span>
            </div>
            <div class="mb-3">
              <label for="ht_radius" class="form-label">Rayon HTA (km)</label>
              <input
                type="range"
                id="ht_radius"
                class="form-range"
                min="0" max="20" step="0.1"
                value="1.0"
              />
              <span id="ht_radius_val" class="ms-2">1.0 km</span>
            </div>
            <div class="mb-3">
              <label for="bt_radius" class="form-label">Rayon BT (km)</label>
              <input
                type="range"
                id="bt_radius"
                class="form-range"
                min="0" max="20" step="0.1"
                value="1.0"
              />
              <span id="bt_radius_val" class="ms-2">1.0 km</span>
            </div>

            <button type="submit" class="btn btn-primary w-100">Rechercher</button>
          </form>
          </div>

          <!-- 2bis) Panneau d’infos -->
          <div id="info-panel" class="mb-4"></div>

          <!-- 3) Recherche par Commune & Culture -->
          <!-- 3) Recherche par Commune & Culture -->
          <div id="form_commune" class="search-form mb-4">
          <form id="communeSearchForm">
              <label for="commune" class="form-label">Commune</label>
              <input
                type="text"
                id="commune"
                class="form-control"
                placeholder="Entrez une commune"
                required
              />
            </div>
            <div class="mb-3">
              <label for="culture" class="form-label">Type de culture (RPG)</label>
              <select id="culture" class="form-select">
                <option value="">-- Toutes --</option>
                {% for c in culture_options %}
                  <option value="{{ c }}">{{ c }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="min_surface" class="form-label">Surface min (ha)</label>
              <input type="number" id="min_surface" class="form-control" placeholder="ex : 1.0" />
            </div>
            <div class="mb-3">
              <label for="max_surface" class="form-label">Surface max (ha)</label>
              <input type="number" id="max_surface" class="form-control" placeholder="ex : 10.0" />
            </div>
            <div class="mb-3">
              <label for="ht_max_distance" class="form-label">Dist. max Postes HTA (km)</label>
              <input type="range" id="ht_max_distance" class="form-range" min="0" max="20" step="0.1" value="1.0"/>
              <span id="ht_max_distance_val" class="ms-2">1.0 km</span>
            </div>
            <div class="mb-3">
              <label for="bt_max_distance" class="form-label">Dist. max Postes BT (km)</label>
              <input type="range" id="bt_max_distance" class="form-range" min="0" max="20" step="0.1" value="1.0"/>
              <span id="bt_max_distance_val" class="ms-2">1.0 km</span>
            </div>
            <div class="mb-3">
              <label for="sirene_radius_commune" class="form-label">Rayon Sirène (km)</label>
              <input type="range" id="sirene_radius_commune" class="form-range" min="0" max="10" step="0.1" value="0.05"/>
              <span id="sirene_radius_commune_val" class="ms-2">0.05 km</span>
            </div>
            <button type="button" id="communeSearchButton" class="btn btn-secondary w-100">
              Rechercher par Commune
            </button>
          </form>
          </div>
          <!-- 4) SSE Progress & Résultats -->
          <div id="ssePanel" class="mb-4">
            <div class="progress mb-2">
              <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%">0%</div>
            </div>
            <pre id="log" class="bg-light p-2" style="height:4em; overflow:auto;"></pre>
            <table class="table table-sm" id="resultsTable">
              <thead>
                <tr><th>Commune</th><th># Parcelles</th><th># Éleveurs</th></tr>
              </thead>
              <tbody></tbody>
            </table>
            <p><strong>Total éleveurs :</strong> <span id="totalEleveurs">0</span></p>
          </div>
        </div>
      </div>

      <!-- Carte + calque SSE -->
      <div id="mapContainer">
        <iframe id="mapFrame" src="/map.html"></iframe>
        <div id="mapSSE"></div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/main.js"></script>
</body>
</html>
