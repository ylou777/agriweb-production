<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mon App G√©o</title>
  <!-- Polices et styles externes -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    html, body {
      height: 100%;
      min-height: 100vh;
    }
    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    /* === CSS FORCE SIDEBAR √Ä GAUCHE === */
    .main-container {
      flex: 1 1 0;
      display: flex !important;
      flex-direction: row !important;
      min-height: 0;
      height: 100vh; /* Pleine hauteur maintenant qu'il n'y a plus de navbar */
      overflow: hidden;
      align-items: stretch;
      position: relative;
    }
    
    /* SIDEBAR FORC√âE √Ä GAUCHE */
    #sidebar {
      position: absolute !important;
      left: 0 !important;
      top: 0 !important;
      width: 340px !important;
      min-width: 340px !important;
      max-width: 340px !important;
      height: 100% !important;
      overflow-y: auto;
      background: #fff !important;
      z-index: 10 !important;
      border-right: 1px solid #f1f1f1;
      display: flex !important;
      flex-direction: column !important;
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
    }
    
    /* CARTE FORC√âE √Ä DROITE */
    #mapFrame {
      position: absolute !important;
      left: 340px !important;
      top: 0 !important;
      width: calc(100% - 340px) !important;
      height: 100% !important;
      min-width: 0;
      border: none;
      display: block;
      background: #eee;
    }
    .layer-list {
      list-style: none;
      padding-left: 0;
      margin: 0 0 1em 0;
    }
    .layer-list li {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .layer-color {
      width: 14px;
      height: 14px;
      display: inline-block;
      border-radius: 4px;
      margin-right: 8px;
      border: 1px solid #bbb;
    }
    pre {
      background: #f0f0f0;
      padding: 1em;
      height: 200px;
      overflow: auto;
      font-size: .8rem;
    }
    .slider-value {
      font-weight: 500;
    }
    /* Responsive sidebar pour mobile */
    @media (max-width: 991px) {
      .main-container {
        flex-direction: column !important;
        position: relative !important;
      }
      #sidebar {
        position: fixed !important;
        left: -100vw !important;
        top: 0 !important; /* Plus de d√©calage de navbar */
        width: 90vw !important;
        max-width: 98vw !important;
        height: 100vh !important; /* Pleine hauteur */
        z-index: 1050 !important;
        box-shadow: 4px 0 24px #0002;
        transition: left 0.3s;
        flex-direction: column !important;
      }
      #sidebar.show {
        left: 0 !important;
      }
      #mapFrame {
        position: relative !important;
        left: 0 !important;
        top: 0 !important;
        width: 100% !important;
        height: 100vh !important; /* Pleine hauteur */
      }
    }
    #closeSidebarBtn { display: none; }
    @media (max-width: 991px) {
      #closeSidebarBtn { display: inline-block; }
    }
    
    /* Force TOUS les contr√¥les de carte au-dessus de TOUT */
    .leaflet-control-layers,
    .leaflet-control-zoom,
    .leaflet-control-zoom-in,
    .leaflet-control-zoom-out,
    .leaflet-control,
    .leaflet-top,
    .leaflet-bottom,
    .leaflet-left,
    .leaflet-right,
    .leaflet-control-container,
    .leaflet-control-layers-base,
    .leaflet-control-layers-overlays,
    .leaflet-control-layers-toggle {
      z-index: 9999 !important;
    }
    
    /* Force sp√©cifiquement les boutons de zoom et layer control */
    .leaflet-control-zoom a,
    .leaflet-control-layers-toggle,
    .leaflet-control-layers-list {
      z-index: 9999 !important;
    }
    
    /* Bouton flottant pour mobile */
    #openSidebarBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 10000;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: none;
    }
    
    @media (max-width: 991px) {
      #openSidebarBtn {
        display: block;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- SIDEBAR DOIT √äTRE √Ä GAUCHE - PREMIER √âL√âMENT -->
    <div id="sidebar" class="text-dark">
      <div class="offcanvas-header d-flex align-items-center px-3 pt-3">
        <h5 class="offcanvas-title flex-grow-1 mb-0">üó∫Ô∏è Mon App G√©o</h5>
        <button id="closeSidebarBtn" class="btn-close text-reset ms-2" type="button"></button>
      </div>
      <div class="offcanvas-body p-0">
        <div class="accordion" id="searchAccordion">
          {% include 'search_panel.html' %}
        </div>
        <hr class="m-0">
        <div class="p-3">
          <h6 class="fw-bold">Calques visibles</h6>
          <ul id="layerControlList" class="layer-list"></ul>
          <h6 class="fw-bold mt-4">Informations</h6>
          <div id="info-panel"></div>
          <button id="reportButton" type="button" class="btn btn-warning w-100 mt-2">G√©n√©rer rapport (point courant)</button>
          <button id="communeReportBtn" type="button" class="btn btn-outline-primary w-100 mt-2">G√©n√©rer rapport commune</button>
          <button id="deptReportCarteBtn" type="button" class="btn btn-outline-success w-100 mt-2">
            G√©n√©rer rapport d√©partement (√† partir de la carte)
          </button>
          <hr class="mt-3 mb-3">
          <button id="homeBtn" type="button" class="btn btn-outline-secondary w-100 mt-2" onclick="window.location.href='/'">
            <i class="bi bi-house"></i> Accueil
          </button>
          <button id="logoutBtn" type="button" class="btn btn-outline-danger w-100 mt-2" onclick="window.location.href='/logout'">
            <i class="bi bi-box-arrow-right"></i> D√©connexion
          </button>
        </div>
      </div>
    </div>
    <!-- CARTE DOIT √äTRE √Ä DROITE - DEUXI√àME √âL√âMENT -->
    <iframe id="mapFrame" src="/static/map.html" title="Carte interactive"></iframe>
    
    <!-- Bouton flottant pour ouvrir la sidebar sur mobile -->
    <button id="openSidebarBtn" type="button">
      <i class="bi bi-list"></i>
    </button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/main.js"></script>
  <script>
    // Sidebar responsive (fixe desktop, offcanvas mobile)
    const sidebar = document.getElementById('sidebar');
    const openBtn = document.getElementById('openSidebarBtn');
    const closeBtn = document.getElementById('closeSidebarBtn');

    function openSidebar() {
      sidebar.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    function closeSidebar() {
      sidebar.classList.remove('show');
      document.body.style.overflow = '';
    }
    if (openBtn) openBtn.addEventListener('click', openSidebar);
    if (closeBtn) closeBtn.addEventListener('click', closeSidebar);

    // Ferme sidebar sur clic ext√©rieur (mobile uniquement)
    window.addEventListener('click', function(e) {
      if(window.innerWidth > 991) return;
      if(sidebar.classList.contains('show') && !sidebar.contains(e.target) && e.target !== openBtn) {
        closeSidebar();
      }
    });
    // Ferme la sidebar sur resize desktop
    window.addEventListener('resize', () => {
      if(window.innerWidth > 991) closeSidebar();
    });

    // Contr√¥le des calques depuis main.js
    function updateLayerSidebarControl(layers) {
      const list = document.getElementById("layerControlList");
      if (!list) return;
      list.innerHTML = '';
      Object.entries(layers).forEach(([key, config]) => {
        const li = document.createElement('li');
        const box = document.createElement('input');
        box.type = "checkbox";
        box.checked = true;
        box.dataset.layer = key;
        box.style.marginRight = "7px";
        box.onchange = function() {
          const m = document.getElementById("mapFrame").contentWindow;
          if (m && typeof m.toggleLayerVisibility === "function") {
            m.toggleLayerVisibility(key, box.checked);
          } else if (m && m.toggleLayerVisibility) {
            m.toggleLayerVisibility(key, box.checked);
          }
        };
        const color = document.createElement('span');
        color.className = 'layer-color';
        color.style.background = config.color || '#bbb';
        li.appendChild(box);
        li.appendChild(color);
        li.appendChild(document.createTextNode(config.label || key));
        list.appendChild(li);
      });
    }
    window.updateLayerSidebarControl = updateLayerSidebarControl;
    
    // Gestion du zoom automatique depuis les param√®tres d'URL
    {% if zoom_lat and zoom_lon %}
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üéØ Zoom automatique demand√©:', {{ zoom_lat }}, {{ zoom_lon }}, '{{ zoom_address }}');
        
        // Attendre que la carte soit charg√©e avant de faire la recherche
        setTimeout(function() {
            // D√©clencher une recherche par coordonn√©es
            const searchForm = document.querySelector('#address-search-form');
            const latInput = document.querySelector('#lat');
            const lonInput = document.querySelector('#lon');
            const addressInput = document.querySelector('#address');
            
            if (latInput && lonInput) {
                latInput.value = {{ zoom_lat }};
                lonInput.value = {{ zoom_lon }};
                {% if zoom_address %}
                if (addressInput) {
                    addressInput.value = '{{ zoom_address }}';
                }
                {% endif %}
                
                // D√©clencher la recherche
                if (searchForm) {
                    console.log('üîç D√©clenchement recherche automatique');
                    searchForm.dispatchEvent(new Event('submit'));
                } else {
                    console.warn('Formulaire de recherche non trouv√©');
                }
            } else {
                console.warn('Champs lat/lon non trouv√©s');
            }
        }, 2000);
    });
    {% endif %}
  </script>
</body>
</html>
