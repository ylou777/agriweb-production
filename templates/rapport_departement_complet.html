<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rapport Département</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      line-height: 1.6; 
    }
    .header { 
      text-align: center; 
      margin-bottom: 30px; 
    }
    .synth-section { 
      background: #e8eefa; 
      padding: 15px 24px 22px 24px; 
      margin-bottom: 44px; 
      border-radius: 10px; 
    }
    .section { 
      margin-bottom: 44px; 
    }
    .label { 
      font-weight: bold; 
      color: #224; 
    }
    .small { 
      font-size: 0.95em; 
      color: #777; 
    }
    a { 
      color: #275dab; 
      text-decoration: none;
    }
    a:hover { 
      text-decoration: underline;
    }
    .top50 { 
      width: 100%; 
      border-collapse: collapse; 
      margin: 18px 0; 
    }
    .top50 th, .top50 td { 
      border: 1px solid #ddd; 
      padding: 8px; 
      text-align: left; 
      font-size: 1em; 
    }
    .top50 th { 
      background-color: #f2f2f2; 
    }
    .mairie-box { 
      margin: 10px 0 25px 0; 
      background: #f2f7ff; 
      border-radius: 8px; 
      padding: 12px 22px; 
    }
    .mairie-box h4 { 
      margin: 0 0 7px 0; 
      color: #275dab; 
    }
    .mairie-box span { 
      display: block; 
    }
    .carte-iframe { 
      width: 100%; 
      height: 600px; 
      border: 1px solid #888; 
      border-radius: 8px; 
      margin-bottom: 32px; 
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    table th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Rapport du département {{ dept or '' }}</h1>
  </div>

  {% if carte_url %}
    <h3>Carte interactive</h3>
    <iframe class="carte-iframe" src="/{{ carte_url }}" allowfullscreen title="Carte interactive du département"></iframe>
  {% endif %}

  {% if synthese %}
  <div class="synth-section">
    <h2>Synthèse départementale</h2>
    <ul>
      <li>Nombre total d'agriculteurs : <b>{{ synthese.nb_agriculteurs }}</b></li>
      <li>Nombre total de parcelles RPG : <b>{{ synthese.nb_parcelles }}</b></li>
    </ul>
    
    {% if synthese.top50 %}
    <h3>Top 50 parcelles les plus proches d'un poste d'injection</h3>
    <table class="top50">
      <thead>
        <tr>
          <th>ID RPG</th>
          <th>Section</th>
          <th>N° Parcelle</th>
          <th>ID Commune</th>
          <th>Code Abs</th>
          <th>Surface (ha)</th>
          <th>Culture</th>
          <th>Coordonnées (lon, lat)</th>
          <th>Distance au poste (m)</th>
          <th>Lien Cadastre</th>
        </tr>
      </thead>
      <tbody>
      {% for p in synthese.top50 %}
        <tr>
          <td>{{ p.properties.ID_PARCEL or p.properties.id or 'N/A' }}</td>
          <td>{{ p.properties.section or p.properties.cadastre_section or 'N/A' }}</td>
          <td>{{ p.properties.numero_parcelle or p.properties.cadastre_numero or 'N/A' }}</td>
          <td>{{ p.properties.code_com or 'N/A' }}</td>
          <td>{{ p.properties.com_abs or 'N/A' }}</td>
          <td>{{ p.properties.SURF_PARC or p.properties.surface or 'N/A' }}</td>
          <td>{{ p.properties.CODE_CULTU or p.properties.Culture or 'N/A' }}</td>
          <td>
            {% if p.properties.coords %}
              {{ p.properties.coords[0] }}, {{ p.properties.coords[1] }}
            {% else %}N/A{% endif %}
          </td>
          <td>
            {% if p.properties.distance_formatted %}
              {{ p.properties.distance_formatted }}
            {% elif p.properties.distance_valid == false %}
              <span style="color: red;">Distance non calculée</span>
            {% else %}
              {{ p.properties.distance_bt or p.properties.distance_au_poste or p.properties.distance_hta or p.properties.min_bt_distance_m or p.properties.min_ht_distance_m or 'N/A m' }}
            {% endif %}
          </td>
          <td>
            {% if p.properties.cadastre_link and p.properties.cadastre_link_valid %}
              <a href="{{ p.properties.cadastre_link }}" target="_blank" rel="noopener">Cadastre</a>
            {% else %}
              {% set nomcommune = (p.properties.nom_com or p.properties.nom_commune or 'commune') | lower | replace(' ', '-') %}
              {% set code_com = p.properties.code_com or '' %}
              {% set com_abs = p.properties.com_abs or '000' %}
              {% set section = p.properties.section or '' %}
              {% set numero = p.properties.numero or '' %}
              {% set idu = code_com ~ com_abs ~ section ~ numero %}
              {% if code_com and section and numero and nomcommune and idu|length >= 10 %}
                <a href="https://france-cadastre.fr/cadastre/{{ nomcommune }}&id={{ idu }}" target="_blank" rel="noopener">Cadastre</a>
              {% else %}
                <span style="color: orange;">Lien non disponible</span>
              {% endif %}
            {% endif %}
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    {% endif %}
  </div>
  {% endif %}

  {% for report in reports %}
    <div class="section">
      <h2>Commune : {{ report.nom or report.commune or 'N/A' }}</h2>
      
      {% if report.mairie %}
      <div class="mairie-box">
        <h4>Mairie</h4>
        <span><b>Adresse :</b> {{ report.mairie.adresse or report.mairie.adresse_complete or 'N/A' }}</span>
        <span><b>Téléphone :</b> {{ report.mairie.telephone or 'N/A' }}</span>
        {% if report.mairie.email %}<span><b>Email :</b> {{ report.mairie.email }}</span>{% endif %}
        {% if report.mairie.site %}<span><b>Site web :</b> <a href="{{ report.mairie.site }}" target="_blank">{{ report.mairie.site }}</a></span>{% endif %}
      </div>
      {% endif %}
      
      <ul>
        <li>
          Nombre de parcelles RPG :
          {{ report.rpg_parcelles.features|length if report.rpg_parcelles and report.rpg_parcelles.features else '0' }}
        </li>
        <li>
          Nombre de postes BT :
          {{ report.postes_bt.features|length if report.postes_bt and report.postes_bt.features else '0' }}
        </li>
        <li>
          Nombre de postes HTA :
          {{ report.postes_hta.features|length if report.postes_hta and report.postes_hta.features else '0' }}
        </li>
        <li>
          Nombre d'éleveurs :
          {{ report.eleveurs.features|length if report.eleveurs and report.eleveurs.features else '0' }}
        </li>
      </ul>
      
      <div class="small">
        <span class="label">Surface :</span> {{ report.surface or 'N/A' }} ha &nbsp; 
        <span class="label">Population :</span> {{ report.population or 'N/A' }}
      </div>

      <h3>Parcelles RPG</h3>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Section</th>
            <th>N° Parcelle</th>
            <th>Surface (ha)</th>
            <th>Culture</th>
            <th>Coordonnées (lon, lat)</th>
            <th>Distance BT (m)</th>
            <th>Distance HTA (m)</th>
            <th>Lien Cadastre</th>
          </tr>
        </thead>
        <tbody>
        {% if report.rpg_parcelles and report.rpg_parcelles.features and report.rpg_parcelles.features|length > 0 %}
          {% for p in report.rpg_parcelles.features %}
            <tr>
              <td>{{ p.properties.ID_PARCEL or p.properties.id or 'N/A' }}</td>
              <td>{{ p.properties.section or p.properties.cadastre_section or 'N/A' }}</td>
              <td>{{ p.properties.numero_parcelle or p.properties.cadastre_numero or 'N/A' }}</td>
              <td>{{ p.properties.SURF_PARC or p.properties.surface or 'N/A' }}</td>
              <td>{{ p.properties.CODE_CULTU or p.properties.Culture or 'N/A' }}</td>
              <td>
                {% if p.properties.coords %}
                  {{ p.properties.coords[0] }}, {{ p.properties.coords[1] }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td>{{ p.properties.distance_bt or p.properties.distance_au_poste or p.properties.min_bt_distance_m or 'N/A' }}</td>
              <td>{{ p.properties.distance_hta or p.properties.min_ht_distance_m or 'N/A' }}</td>
              <td>
                {% set nomcommune = (p.properties.nom_com or p.properties.nom_commune or 'commune') | lower | replace(' ', '-') %}
                {% set code_com = p.properties.code_com or '' %}
                {% set com_abs = p.properties.com_abs or '000' %}
                {% set section = p.properties.section or '' %}
                {% set numero = p.properties.numero or '' %}
                {% set idu = code_com ~ com_abs ~ section ~ numero %}
                {% if code_com and section and numero and nomcommune and idu|length >= 10 %}
                  <a href="https://france-cadastre.fr/cadastre/{{ nomcommune }}&id={{ idu }}" target="_blank">Cadastre</a>
                {% else %}
                  N/A
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="9" style="text-align:center;">Aucune parcelle</td></tr>
        {% endif %}
        </tbody>
      </table>

      <h3>Postes BT</h3>
      {% if report.postes_bt and report.postes_bt.features and report.postes_bt.features|length > 0 %}
        <ul>
          {% for poste in report.postes_bt.features %}
            <li>{{ poste.properties.nom or poste.properties.nom_poste or 'N/A' }} ({{ poste.properties.distance or 'N/A' }} m)</li>
          {% endfor %}
        </ul>
      {% else %}
        <em>Aucun poste BT.</em>
      {% endif %}

      <h3>Postes HTA</h3>
      {% if report.postes_hta and report.postes_hta.features and report.postes_hta.features|length > 0 %}
        <ul>
          {% for poste in report.postes_hta.features %}
            <li>{{ poste.properties.nom or poste.properties.nom_poste or 'N/A' }} ({{ poste.properties.distance or 'N/A' }} m)</li>
          {% endfor %}
        </ul>
      {% else %}
        <em>Aucun poste HTA.</em>
      {% endif %}

      <h3>Capacités d'accueil réseau HTA</h3>
      {% if report.hta_capacites and report.hta_capacites.features and report.hta_capacites.features|length > 0 %}
        <table>
          <thead>
            <tr>
              <th>Nom Poste</th>
              <th>Capacité (MW)</th>
              <th>Statut</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody>
            {% for c in report.hta_capacites.features %}
              <tr>
                <td>{{ c.properties.nom_poste or c.properties.nom or 'N/A' }}</td>
                <td>{{ c.properties.capacite or c.properties.capacite_dispo or 'N/A' }}</td>
                <td>{{ c.properties.statut or 'N/A' }}</td>
                <td>{{ c.properties.commentaire or 'N/A' }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <em>Pas de données de capacités HTA pour cette commune.</em>
      {% endif %}

      <h3>Éleveurs</h3>
      <table>
        <thead>
          <tr>
            <th>Nom</th>
            <th>Prénom</th>
            <th>Adresse</th>
            <th>SIRET</th>
            <th>Annuaire</th>
            <th>Entreprise</th>
            <th>Pages Blanches</th>
          </tr>
        </thead>
        <tbody>
          {% if report.eleveurs and report.eleveurs.features and report.eleveurs.features|length > 0 %}
            {% for e in report.eleveurs.features %}
              <tr>
                <td>{{ e.properties.nom or e.properties.nomUniteLe or 'N/A' }}</td>
                <td>{{ e.properties.prenom or e.properties.prenom1Uni or 'N/A' }}</td>
                <td>{{ e.properties.adresse or e.properties.adresseEtablissement or 'N/A' }}</td>
                <td>{{ e.properties.siret or 'N/A' }}</td>
                <td>
                  {% if e.properties.lien_annuaire %}
                    <a href="{{ e.properties.lien_annuaire }}" target="_blank">Annuaire</a>
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if e.properties.lien_entreprise %}
                    <a href="{{ e.properties.lien_entreprise }}" target="_blank">Entreprise</a>
                  {% else %}
                    N/A
                  {% endif %}
                </td>
                <td>
                  {% if e.properties.lien_pages_blanches %}
                    <a href="{{ e.properties.lien_pages_blanches }}" target="_blank">Pages Blanches</a>
                  {% else %}
                    N/A
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr><td colspan="7" style="text-align:center;">Aucun éleveur</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  {% endfor %}
</body>
</html>
