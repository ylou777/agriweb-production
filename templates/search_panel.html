<!-- search_panel.html : UNIQUEMENT les accordion-items, pas de <div class="accordion"> ici ! -->

<!-- Section Adresse / Coordonn√©es / GeoJSON -->
<div class="accordion-item">
  <h2 class="accordion-header">
    <button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#acc-pane-addr" aria-expanded="true" aria-controls="acc-pane-addr">
      <span class="me-2"><i class="bi bi-geo-alt-fill"></i></span> Adresse ‚Ä¢ Coordonn√©es ‚Ä¢ GeoJSON
    </button>
  </h2>
  <div id="acc-pane-addr" class="accordion-collapse collapse show">
    <div class="accordion-body">
      <form id="unifiedSearchForm" autocomplete="off">
        <label class="form-label" for="search_input">Adresse, coordonn√©es ou GeoJSON :</label>
        <input id="search_input" class="form-control mb-2" placeholder='48.85,2.35 ou {"type":"Point",...}'>

        <div class="mb-2">
          <label class="form-label" for="sirene_radius">Rayon Sir√®ne <span id="sirene_radius_val" class="slider-value"></span></label>
          <input id="sirene_radius" type="range" class="form-range" min="0" max="10" step="0.1" value="0.05">
        </div>
        <div class="mb-2">
          <label class="form-label" for="bt_max_distance">Distance BT (m) <span id="btMaxValAddr" class="slider-value"></span></label>
          <input id="bt_max_distance" type="range" class="form-range" min="0" max="2000" step="50" value="500">
        </div>
        <div>
          <label class="form-label" for="ht_max_distance">Distance HTA (m) <span id="htMaxValAddr" class="slider-value"></span></label>
          <input id="ht_max_distance" type="range" class="form-range" min="0" max="5000" step="50" value="3500">
        </div>
        <input type="hidden" id="latitude">
        <input type="hidden" id="longitude">
        <input type="hidden" id="address">
        <button type="submit" class="btn btn-primary w-100 mt-3">Rechercher</button>
      </form>
      
      <!-- Zone de logs pour la recherche par adresse -->
      <div id="searchLog" class="form-text text-info mb-2 mt-2" style="min-height:1.5em; max-height:120px; overflow-y:auto; border:1px solid #dee2e6; border-radius:4px; padding:8px; background-color:#f8f9fa; font-size:0.85em; display:none;">
        <!-- Les logs appara√Ætront ici dynamiquement -->
      </div>
    </div>
  </div>
</div>

<!-- Section Commune -->
<div class="accordion-item">
  <h2 class="accordion-header">
    <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#acc-pane-commune" aria-expanded="false" aria-controls="acc-pane-commune">
  <span class="me-2"><i class="bi bi-building"></i></span> Commune
    </button>
  </h2>
  <div id="acc-pane-commune" class="accordion-collapse collapse">
    <div class="accordion-body">
      <form id="communeSearchForm" autocomplete="off">
        <label class="form-label" for="commune">Commune :</label>
        <input id="commune" class="form-control mb-2" placeholder="Lyon">
        <div class="mb-2">
          <label class="form-label" for="sirene_radius_commune">Rayon Sir√®ne <span id="sireneCommVal" class="slider-value"></span></label>
          <input id="sirene_radius_commune" type="range" class="form-range" min="0" max="10" step="0.1" value="0.05">
        </div>
        
        <!-- Filtres par type de donn√©es -->
        <div class="mb-3">
          <h6 class="fw-bold mb-2">Filtres par couche :</h6>
          
          <!-- Filtres RPG -->
          <div class="card mb-2">
            <div class="card-header py-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filter_rpg_commune" checked>
                <label class="form-check-label fw-bold" for="filter_rpg_commune">
                  <i class="bi bi-geo-fill text-success"></i> RPG (Cultures)
                </label>
              </div>
            </div>
            <div class="card-body py-2" id="rpg_filters">
              <div class="row g-2 mb-2">
                <div class="col-12">
                  <label class="form-label small" for="culture">Type de culture</label>
                  <select id="culture" class="form-select form-select-sm">
                    <option value="">Toutes</option>
                    {% for culture in culture_options %}<option value="{{culture}}">{{culture}}</option>{% endfor %}
                  </select>
                </div>
              </div>
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small">Surface min (ha)</label>
                  <input type="number" class="form-control form-control-sm" id="rpg_min_area" value="0.1" min="0" step="0.1">
                </div>
                <div class="col-6">
                  <label class="form-label small">Surface max (ha)</label>
                  <input type="number" class="form-control form-control-sm" id="rpg_max_area" value="50" min="0" step="0.1">
                </div>
              </div>
            </div>
          </div>
          
          <!-- Filtres Parkings -->
          <div class="card mb-2">
            <div class="card-header py-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filter_parkings_commune">
                <label class="form-check-label fw-bold" for="filter_parkings_commune">
                  <i class="bi bi-p-circle-fill text-primary"></i> Parkings
                </label>
              </div>
            </div>
            <div class="card-body py-2" id="parking_filters">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small">Surface min (m¬≤)</label>
                  <input type="number" class="form-control form-control-sm" id="parking_min_area" value="1500" min="0" step="100">
                </div>
                <!-- Distance unifi√©e via section "Filtrage par distance aux postes" -->
                <div class="col-6">
                  <label class="form-label small text-muted">Distance aux postes</label>
                  <input type="text" class="form-control form-control-sm" value="R√©gl√©e ci-dessous" disabled>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Filtres Friches -->
          <div class="card mb-2">
            <div class="card-header py-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filter_friches_commune">
                <label class="form-check-label fw-bold" for="filter_friches_commune">
                  <i class="bi bi-triangle-fill text-warning"></i> Friches
                </label>
              </div>
            </div>
            <div class="card-body py-2" id="friches_filters">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small">Surface min (m¬≤)</label>
                  <input type="number" class="form-control form-control-sm" id="friches_min_area" value="1000" min="0" step="100">
                </div>
                <!-- Distance unifi√©e via section "Filtrage par distance aux postes" -->
                <div class="col-6">
                  <label class="form-label small text-muted">Distance aux postes</label>
                  <input type="text" class="form-control form-control-sm" value="R√©gl√©e ci-dessous" disabled>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Filtres Zones -->
          <div class="card mb-2">
            <div class="card-header py-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filter_zones_commune">
                <label class="form-check-label fw-bold" for="filter_zones_commune">
                  <i class="bi bi-map-fill text-info"></i> Zones (PLU/GPU)
                </label>
              </div>
            </div>
            <div class="card-body py-2" id="zones_filters">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label small">Surface min (m¬≤)</label>
                  <input type="number" class="form-control form-control-sm" id="zones_min_area" value="1000" min="0" step="100">
                </div>
                <div class="col-6">
                  <label class="form-label small">Type zone</label>
                  <select class="form-select form-select-sm" id="zones_type_filter">
                    <option value="">Toutes</option>
                    <option value="A">Zone A (Agricole)</option>
                    <option value="U">Zone U (Urbaine)</option>
                    <option value="N">Zone N (Naturelle)</option>
                    <option value="AU">Zone AU (√Ä urbaniser)</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Filtres Toitures -->
          <div class="card mb-2">
            <div class="card-header py-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filter_toitures_commune">
                <label class="form-check-label fw-bold" for="filter_toitures_commune">
                  <i class="bi bi-house-fill text-danger"></i> Toitures
                </label>
              </div>
            </div>
            <div class="card-body py-2" id="toitures_filters">
              <div class="row g-2 mb-2">
                <div class="col-12">
                  <label class="form-label small">Surface minimale toiture (m¬≤) : <span id="minSurfaceToitureVal" class="slider-value">100</span></label>
                  <input id="min_surface_toiture" type="range" class="form-range" min="50" max="5000" step="25" value="100">
                </div>
              </div>
              <div class="mt-2">
                <small class="text-muted">
                  <i class="bi bi-info-circle"></i> Recherche sur l'ensemble du territoire de la commune (m√©thode polygone pr√©cise)<br>
                  <i class="bi bi-lightning"></i> Les distances aux postes sont configur√©es dans la section "Filtrage par distance aux postes" ci-dessous
                </small>
              </div>
              <!-- Zone d'affichage des r√©sultats toitures -->
              <div id="toitures-results" class="mt-2" style="display: none;">
                <div id="toitures-stats" class="alert alert-success p-2 mb-2"></div>
                <div id="toitures-list" class="list-group"></div>
              </div>
            </div>
          </div>
          
          <!-- Filtres de distance globaux -->
          <div class="card mb-2">
            <div class="card-header py-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="filter_by_distance_commune">
                <label class="form-check-label fw-bold" for="filter_by_distance_commune">
                  <i class="bi bi-geo-alt-fill text-success"></i> Filtrage par distance aux postes
                </label>
              </div>
            </div>
            <div class="card-body py-2" id="distance_filters">
              <!-- S√©lection du type de poste -->
              <div class="mb-2">
                <label class="form-label small">Type de poste √† consid√©rer :</label>
                <div class="btn-group w-100" role="group" aria-label="Type de poste">
                  <input type="radio" class="btn-check" name="poste_type_filter" id="poste_type_all" value="ALL" checked>
                  <label class="btn btn-outline-primary btn-sm" for="poste_type_all">
                    <i class="bi bi-lightning-charge"></i> Tous
                  </label>
                  
                  <input type="radio" class="btn-check" name="poste_type_filter" id="poste_type_bt" value="BT">
                  <label class="btn btn-outline-success btn-sm" for="poste_type_bt">
                    <i class="bi bi-lightning"></i> BT seulement
                  </label>
                  
                  <input type="radio" class="btn-check" name="poste_type_filter" id="poste_type_hta" value="HTA">
                  <label class="btn btn-outline-warning btn-sm" for="poste_type_hta">
                    <i class="bi bi-lightning-charge-fill"></i> HTA seulement
                  </label>
                </div>
              </div>
              
              <!-- Contr√¥les de distance BT et HTA -->
              <div class="row g-2 mb-2">
                <div class="col-6">
                  <label class="form-label small">Distance BT max (m) : <span id="btMaxValCommune" class="slider-value">2000</span></label>
                  <input id="bt_max_distance_commune" type="range" class="form-range" min="0" max="5000" step="50" value="2000">
                </div>
                <div class="col-6">
                  <label class="form-label small">Distance HTA max (m) : <span id="htMaxValCommune" class="slider-value">5000</span></label>
                  <input id="ht_max_distance_commune" type="range" class="form-range" min="0" max="10000" step="50" value="5000">
                </div>
              </div>
              
              <!-- Contr√¥les de distance pour toitures supprim√©s (utilisent les contr√¥les globaux) -->
              
              <!-- Logique de distance supprim√©e : la s√©lection du type de poste suffit (Tous/BT/HTA) -->
              
              <div class="mt-2">
                <small class="text-muted">
                  <i class="bi bi-info-circle"></i> Applique des crit√®res de distance √† tous les √©l√©ments recherch√©s (parcelles, parkings, friches, toitures...)
                </small>
              </div>
            </div>
          </div>
        </div>
        
  <button id="communeSearchButton" type="submit" class="btn btn-secondary w-100 mt-2">Rechercher commune</button>
  <div id="communeSearchLog" class="form-text text-info mb-2" style="min-height:1.5em;"></div>
      </form>
    </div>
  </div>
</div>

<!-- Section D√©partement -->
<div class="accordion-item">
  <h2 class="accordion-header">
    <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#acc-pane-dept" aria-expanded="false" aria-controls="acc-pane-dept">
      <span class="me-2"><i class="bi bi-globe-europe-africa"></i></span> D√©partement (SSE)
    </button>
  </h2>
  <div id="acc-pane-dept" class="accordion-collapse collapse">
    <div class="accordion-body">
      <label class="form-label" for="departmentInput">D√©partement :</label>
      <input id="departmentInput" class="form-control mb-2" placeholder="23">
      <label class="form-label" for="rpgType">Type RPG :</label>
      <select id="rpgType" class="form-select mb-2">
        <option value="">Tous</option>
        {% for culture in culture_options %}<option value="{{culture}}">{{culture}}</option>{% endfor %}
      </select>
      <div class="mb-2">
        <label class="form-label" for="minSurface">Surface min/max (ha)</label>
        <input id="minSurface" type="range" class="form-range" min="0" max="100" value="10">
        <input id="maxSurface" type="range" class="form-range" min="0" max="100" value="50">
        <small>min : <span id="minSurfaceVal">10</span> ha ‚Äì max : <span id="maxSurfaceVal">50</span> ha</small>
      </div>
      <div class="mb-2">
        <label class="form-label" for="bt_max_distance_dept">Distance BT (m) <span id="btMaxValDept" class="slider-value"></span></label>
        <input id="bt_max_distance_dept" type="range" class="form-range" min="0" max="2000" step="50" value="500">
      </div>
      <div class="mb-2">
        <label class="form-label" for="ht_max_distance_dept">Distance HTA (m) <span id="htMaxValDept" class="slider-value"></span></label>
        <input id="ht_max_distance_dept" type="range" class="form-range" min="0" max="5000" step="50" value="2000">
      </div>
      <!-- Filtrage dynamique HTA/BT -->
      <div class="mb-2">
        <label class="form-label">Types de r√©seaux √† filtrer :</label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="filterHTA" checked>
          <label class="form-check-label" for="filterHTA">HTA + distance</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="filterBT" checked>
          <label class="form-check-label" for="filterBT">BT + distance</label>
        </div>
        <small class="text-muted">
          D√©coche pour ignorer un type de r√©seau dans la recherche (au moins un doit √™tre s√©lectionn√©).
        </small>
      </div>
      <div class="form-check form-switch mt-2">
        <input id="excludeBuildings" class="form-check-input" type="checkbox">
        <label class="form-check-label" for="excludeBuildings">Exclure b√¢timents remarquables 500 m</label>
      </div>
      <div class="form-check form-switch mb-2">
        <input id="excludeNature" class="form-check-input" type="checkbox">
        <label class="form-check-label" for="excludeNature">Exclure zones naturelles</label>
      </div>
      <button id="deptSearchBtn" type="button" class="btn btn-primary w-100">Lancer recherche d√©partement</button>
      <pre id="deptLog" class="mt-3"></pre>
    </div>
  </div>
</div>

<script>
// Gestion de l'affichage des filtres selon les cases coch√©es
document.addEventListener('DOMContentLoaded', function() {
  // Fonction pour toggle l'affichage des filtres
  function toggleFilters(checkboxId, filtersId) {
    const checkbox = document.getElementById(checkboxId);
    const filters = document.getElementById(filtersId);
    
    function updateDisplay() {
      if (filters) {
        filters.style.display = checkbox.checked ? 'block' : 'none';
      }
    }
    
    if (checkbox) {
      checkbox.addEventListener('change', updateDisplay);
      updateDisplay(); // Initial state
    }
  }
  
  // Appliquer pour chaque type de filtre
  toggleFilters('filter_rpg_commune', 'rpg_filters');
  toggleFilters('filter_parkings_commune', 'parking_filters');
  toggleFilters('filter_friches_commune', 'friches_filters');
  toggleFilters('filter_zones_commune', 'zones_filters');
  toggleFilters('filter_toitures_commune', 'toitures_filters');
  
  // Gestion des sliders pour les valeurs dynamiques
  function setupSlider(sliderId, displayId, suffix = '') {
    const slider = document.getElementById(sliderId);
    const display = document.getElementById(displayId);
    
    if (slider && display) {
      const updateDisplay = () => {
        display.textContent = slider.value + suffix;
      };
      
      // Ajout de plusieurs √©v√©nements pour garantir la mise √† jour
      slider.addEventListener('input', updateDisplay);
      slider.addEventListener('change', updateDisplay);
      updateDisplay(); // Initial value
    } else {
      console.warn(`Slider setup failed: ${sliderId} -> ${displayId}`);
    }
  }
  
  // Configuration des sliders pour toutes les sections
  // D√©lai pour s'assurer que les √©l√©ments sont rendus
  setTimeout(() => {
    console.log('Configuration des sliders...');
    
    // Sliders section Adresse
    setupSlider('sirene_radius', 'sirene_radius_val', ' km');
    setupSlider('bt_max_distance', 'btMaxValAddr', ' m');
    setupSlider('ht_max_distance', 'htMaxValAddr', ' m');
    
    // Sliders section Commune
    setupSlider('sirene_radius_commune', 'sireneCommVal', ' km');
    
    // Sliders section Toitures
    setupSlider('min_surface_toiture', 'minSurfaceToitureVal', ' m¬≤');
    
    // Sliders pour les nouveaux contr√¥les de distance commune
    setupSlider('bt_max_distance_commune', 'btMaxValCommune', ' m');
    setupSlider('ht_max_distance_commune', 'htMaxValCommune', ' m');
  // Distances toitures utilisent les contr√¥les globaux
    
    // Sliders section D√©partement
    setupSlider('minSurface', 'minSurfaceVal', ' ha');
    setupSlider('maxSurface', 'maxSurfaceVal', ' ha');
    setupSlider('bt_max_distance_dept', 'btMaxValDept', ' m');
    setupSlider('ht_max_distance_dept', 'htMaxValDept', ' m');
    
    // Force la mise √† jour initiale pour tous les sliders
    const allSliders = [
      'sirene_radius', 'bt_max_distance', 'ht_max_distance',
      'sirene_radius_commune', 'min_surface_toiture',
  'bt_max_distance_commune', 'ht_max_distance_commune',
      'minSurface', 'maxSurface', 'bt_max_distance_dept', 'ht_max_distance_dept'
    ];
    
    allSliders.forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.dispatchEvent(new Event('input'));
      }
    });
  }, 250);
  
  function searchToitures(params) {
    // Cette fonction sera int√©gr√©e dans la recherche commune principale
    console.log('Recherche toitures int√©gr√©e dans la recherche commune');
  }
  
  // Fonction pour afficher les toitures sur la carte
  function displayToituresOnMap(data) {
    const mapFrame = document.getElementById('mapFrame');
    if (!mapFrame || !mapFrame.contentWindow) {
      console.warn('Carte non disponible pour affichage');
      return;
    }
    
    const mapWindow = mapFrame.contentWindow;
    
    try {
      // Centrer la carte sur la commune
      if (data.lat && data.lon && mapWindow.centerMapOnLocation) {
        mapWindow.centerMapOnLocation(data.lat, data.lon, 15);
      }
      
      // Ajouter les couches de toitures et parcelles
      if (mapWindow.addGeoJsonToMap) {
        // Ajouter les toitures en rouge
        data.toitures.features.forEach((toiture, index) => {
          mapWindow.addGeoJsonToMap(toiture, {
            fillColor: '#ff4444',
            color: '#cc0000',
            weight: 2,
            fillOpacity: 0.7,
            popup: `Toiture #${index + 1}<br>Surface: ${toiture.properties.surface_toiture_m2} m¬≤`
          });
        });
        
        // Ajouter les parcelles en vert si disponibles
        if (data.parcelles_toitures && data.parcelles_toitures.features) {
          data.parcelles_toitures.features.forEach(parcelle => {
            mapWindow.addGeoJsonToMap(parcelle, {
              fillColor: '#44ff44',
              color: '#008800',
              weight: 2,
              fillOpacity: 0.3,
              popup: `Parcelle ${parcelle.properties.numero || 'N/A'}<br>Toiture: ${parcelle.properties.toiture_surface_m2} m¬≤`
            });
          });
        }
        
        // Ajouter les postes BT en bleu
        if (data.postes_bt && data.postes_bt.features) {
          data.postes_bt.features.forEach(poste => {
            mapWindow.addGeoJsonToMap(poste, {
              color: '#4444ff',
              fillColor: '#0066ff',
              radius: 5,
              popup: `Poste BT<br>${poste.properties.nom || 'Sans nom'}`
            });
          });
        }
        
        // Ajouter les postes HTA en magenta
        if (data.postes_hta && data.postes_hta.features) {
          data.postes_hta.features.forEach(poste => {
            mapWindow.addGeoJsonToMap(poste, {
              color: '#ff44ff',
              fillColor: '#cc00cc',
              radius: 8,
              popup: `Poste HTA<br>${poste.properties.nom || 'Sans nom'}`
            });
          });
        }
      }
    } catch (error) {
      console.error('Erreur affichage carte:', error);
    }
  }
  
  // Fonction pour zoomer sur une toiture sp√©cifique
  window.zoomToToiture = function(index) {
    if (!window.currentToituresData || !window.currentToituresData.toitures.features[index]) {
      return;
    }
    
    const toiture = window.currentToituresData.toitures.features[index];
    const mapFrame = document.getElementById('mapFrame');
    
    if (mapFrame && mapFrame.contentWindow && mapFrame.contentWindow.zoomToFeature) {
      mapFrame.contentWindow.zoomToFeature(toiture, 18);
    }
  };
});

// Enrichissement: logs en direct via SSE pendant la recherche commune
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('communeSearchForm');
  const logEl = document.getElementById('communeSearchLog');

  function appendLog(msg) {
    if (!logEl) return;
    const now = new Date();
    const ts = now.toLocaleTimeString();
    const line = document.createElement('div');
    line.textContent = `[${ts}] ${msg}`;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  if (form) {
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      // Reset logs
      if (logEl) {
        logEl.innerHTML = '';
      }

      const commune = document.getElementById('commune')?.value?.trim() || '';
      if (!commune) {
        appendLog('Veuillez saisir une commune.');
        return;
      }
  // M√©moriser la derni√®re commune recherch√©e pour le bouton "G√©n√©rer rapport commune"
  try { if (window.setLastCommuneSearched) window.setLastCommuneSearched(commune); } catch {}

      // Collecte des filtres principaux (align√©s avec /rapport_commune_complet)
      function boolVal(id, defVal=false) {
        const el = document.getElementById(id);
        return el ? !!el.checked : defVal;
      }
      function numVal(id, defVal=0) {
        const el = document.getElementById(id);
        const v = el ? parseFloat(el.value) : defVal;
        return isNaN(v) ? defVal : v;
      }

      const params = new URLSearchParams();
      params.set('commune', commune);
      // Filtres par couche
      params.set('filter_rpg', String(boolVal('filter_rpg_commune', true)));
      params.set('rpg_min_area', String(numVal('rpg_min_area', 0.1)));
      params.set('rpg_max_area', String(numVal('rpg_max_area', 50)));

      params.set('filter_parkings', String(boolVal('filter_parkings_commune', false)));
      params.set('parking_min_area', String(numVal('parking_min_area', 1500)));

      params.set('filter_friches', String(boolVal('filter_friches_commune', false)));
      params.set('friches_min_area', String(numVal('friches_min_area', 1000)));

      params.set('filter_zones', String(boolVal('filter_zones_commune', false)));
      params.set('zones_min_area', String(numVal('zones_min_area', 1000)));
      params.set('zones_type_filter', document.getElementById('zones_type_filter')?.value || '');

      params.set('filter_toitures', String(boolVal('filter_toitures_commune', false)));
      params.set('toitures_min_surface', String(numVal('min_surface_toiture', 100)));

      // Filtres distance unifi√©s
      const filterByDist = document.getElementById('filter_by_distance_commune')?.checked || false;
      params.set('filter_by_distance', String(filterByDist));
      params.set('max_distance_bt', String(numVal('bt_max_distance_commune', 2000)));
      params.set('max_distance_hta', String(numVal('ht_max_distance_commune', 5000)));
      const posteType = document.querySelector('input[name="poste_type_filter"]:checked')?.value || 'ALL';
      params.set('poste_type_filter', posteType);
      
      // D√©marre EventSource
      const url = '/commune_search_sse?' + params.toString();
      const es = new EventSource(url);
      appendLog('Analyse en cours‚Ä¶');

      es.addEventListener('message', (ev) => {
        if (ev?.data) appendLog(ev.data);
      });
  // Plus de redirection automatique: on conserve seulement les logs.
  // Le rapport complet sera lanc√© depuis le bouton d√©di√©.
      es.addEventListener('error', (ev) => {
        appendLog('Erreur pendant l‚Äôanalyse.');
        try { es.close(); } catch {}
      });
      es.addEventListener('done', () => {
        appendLog('Analyse termin√©e.');
        appendLog('üó∫Ô∏è G√©n√©ration de la carte...');
        try { es.close(); } catch {}
        
        // Apr√®s la fin de l'analyse, g√©n√©rer automatiquement la carte
        setTimeout(() => {
          // R√©cup√©rer les m√™mes param√®tres que pour l'EventSource
          const commune = document.getElementById('commune').value.trim();
          console.log('üîç [DEBUG JS] Commune r√©cup√©r√©e:', commune);
          if (commune) {
            // Construire les param√®tres manuellement en r√©cup√©rant TOUS les filtres de la page
            const searchParams = new URLSearchParams();
            
            // Ajouter la commune
            searchParams.append('commune', commune);
            
            // R√©cup√©rer TOUS les filtres depuis leurs √©l√©ments respectifs (avec suffixe _commune)
            // Filtres RPG
            const filterRpg = document.getElementById('filter_rpg_commune')?.checked || false;
            searchParams.append('filter_rpg', filterRpg);
            if (filterRpg) {
              searchParams.append('rpg_min_area', document.getElementById('rpg_min_area')?.value || '0.1');
              searchParams.append('rpg_max_area', document.getElementById('rpg_max_area')?.value || '50');
            }
            
            // Filtres Parkings
            const filterParkings = document.getElementById('filter_parkings_commune')?.checked || false;
            searchParams.append('filter_parkings', filterParkings);
            if (filterParkings) {
              searchParams.append('parking_min_area', document.getElementById('parking_min_area')?.value || '1500');
            }
            
            // Filtres Friches
            const filterFriches = document.getElementById('filter_friches_commune')?.checked || false;
            searchParams.append('filter_friches', filterFriches);
            if (filterFriches) {
              searchParams.append('friches_min_area', document.getElementById('friches_min_area')?.value || '1000');
            }
            
            // Filtres Zones
            const filterZones = document.getElementById('filter_zones_commune')?.checked || false;
            searchParams.append('filter_zones', filterZones);
            if (filterZones) {
              searchParams.append('zones_min_area', document.getElementById('zones_min_area')?.value || '1000');
              searchParams.append('zones_type_filter', document.getElementById('zones_type_filter')?.value || '');
            }
            
            // Filtres Toitures
            const filterToitures = document.getElementById('filter_toitures_commune')?.checked || false;
            searchParams.append('filter_toitures', filterToitures);
            if (filterToitures) {
              searchParams.append('toitures_min_surface', document.getElementById('min_surface_toiture')?.value || '100');
            }
            
            // Filtres Distance (utilise les m√™mes IDs que pour la recherche par adresse)
            const filterDistance = document.getElementById('filter_by_distance')?.checked || false;
            searchParams.append('filter_by_distance', filterDistance);
            if (filterDistance) {
              searchParams.append('max_distance_bt', document.getElementById('max_distance_bt')?.value || '500');
              searchParams.append('max_distance_hta', document.getElementById('max_distance_hta')?.value || '2000');
              const posteType = document.querySelector('input[name="poste_type_filter"]:checked')?.value || 'ALL';
              searchParams.append('poste_type_filter', posteType);
            } else {
              searchParams.append('poste_type_filter', 'ALL');
            }
            
            console.log('üîç [DEBUG JS] URL construite:', '/search_by_commune?' + searchParams.toString());
            
            // Appeler la route qui g√©n√®re la carte
            fetch('/search_by_commune?' + searchParams.toString())
              .then(response => {
                console.log('Status de la r√©ponse:', response.status);
                return response.json();
              })
              .then(data => {
                console.log('‚úÖ R√©ponse JSON compl√®te re√ßue:', data);
                console.log('üîç carte_url dans la r√©ponse:', data.carte_url);
                console.log('üîç Type de carte_url:', typeof data.carte_url);
                
                if (data.carte_url) {
                  console.log('‚úÖ carte_url trouv√©e, recherche de mapFrame...');
                  
                  // Mettre √† jour l'iframe mapFrame avec la nouvelle carte
                  const mapFrame = document.getElementById('mapFrame');
                  console.log('üîç mapFrame trouv√©:', mapFrame);
                  console.log('üîç mapFrame src actuel:', mapFrame ? mapFrame.src : 'null');
                  
                  if (mapFrame) {
                    appendLog('‚úÖ Carte g√©n√©r√©e ! Mise √† jour de la carte...');
                    // Utiliser une URL avec timestamp pour forcer le rechargement
                    const newUrl = data.carte_url + (data.carte_url.includes('?') ? '&' : '?') + 't=' + Date.now();
                    console.log('üöÄ Mise √† jour iframe src vers:', newUrl);
                    
                    mapFrame.src = newUrl;
                    console.log('‚úÖ iframe src mis √† jour');
                    
                    // V√©rifier si la mise √† jour a fonctionn√©
                    setTimeout(() => {
                      console.log('üîç iframe src apr√®s mise √† jour:', mapFrame.src);
                    }, 100);
                    
                  } else {
                    console.log('‚ùå mapFrame non trouv√© dans document actuel');
                    console.log('üîç Recherche dans window.parent...');
                    
                    // Essayer de trouver l'iframe dans la fen√™tre parent
                    try {
                      const parentMapFrame = window.parent?.document?.getElementById('mapFrame');
                      console.log('üîç parentMapFrame:', parentMapFrame);
                      
                      if (parentMapFrame) {
                        appendLog('‚úÖ Carte g√©n√©r√©e ! Mise √† jour de la carte (parent)...');
                        const newUrl = data.carte_url + (data.carte_url.includes('?') ? '&' : '?') + 't=' + Date.now();
                        parentMapFrame.src = newUrl;
                        console.log('‚úÖ Carte mise √† jour (parent):', newUrl);
                      } else {
                        console.log('‚ùå parentMapFrame non trouv√© non plus');
                        // TEST: Redirection directe vers la carte pour voir si √ßa marche
                        appendLog('‚úÖ Carte g√©n√©r√©e ! Test: redirection directe...');
                        console.log('üöÄ REDIRECTION DIRECTE vers:', data.carte_url);
                        window.open(data.carte_url, '_blank');
                      }
                    } catch (e) {
                      console.error('‚ùå Erreur acc√®s parent:', e);
                      appendLog('‚úÖ Carte g√©n√©r√©e ! Test: redirection directe...');
                      console.log('üöÄ REDIRECTION DIRECTE vers:', data.carte_url);
                      window.open(data.carte_url, '_blank');
                    }
                  }
                } else {
                  console.log('‚ùå Pas de carte_url dans la r√©ponse');
                  console.log('üîç Cl√©s disponibles dans data:', Object.keys(data));
                  appendLog('‚ö†Ô∏è Carte non g√©n√©r√©e, utilisez le bouton "G√©n√©rer rapport commune"');
                }
              })
              .catch(err => {
                console.error('Erreur g√©n√©ration carte:', err);
                appendLog('‚ùå Erreur g√©n√©ration carte, utilisez le bouton "G√©n√©rer rapport commune"');
              });
          }
        }, 500);
      });
    });
  }
});
</script>
</div>
