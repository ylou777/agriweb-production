<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport Complet - {{ rapport.commune_info.caracteristiques_generales.nom }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        .map-frame {
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .print-map {
            display: none;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            width: 100%;
            height: auto;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section-header {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #007bff;
            margin: 20px 0 10px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        .score-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
        }
        .score-high { background-color: #28a745; }
        .score-medium { background-color: #ffc107; color: #212529; }
        .score-low { background-color: #dc3545; }
        .analysis-detail {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }
        @media print {
            .no-print { display: none; }
            /* On imprime une image statique si disponible */
            iframe.map-frame { display: none !important; }
            .print-map { display: block !important; }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row no-print">
            <div class="col-12">
                <nav class="navbar navbar-dark bg-primary">
                    <div class="container-fluid">
                        <span class="navbar-brand mb-0 h1">
                            <i class="bi bi-file-earmark-text"></i> Rapport Complet AgriWeb
                        </span>
                        <div>
                            <button class="btn btn-outline-light" onclick="window.print()">
                                <i class="bi bi-printer"></i> Imprimer
                            </button>
                            <button class="btn btn-outline-light" onclick="window.close()">
                                <i class="bi bi-x-circle"></i> Fermer
                            </button>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Contenu principal -->
        <div class="row mt-3">
            <div class="col-12">
                {% if rapport.carte_url %}
                <div class="mb-3">
                    <div class="section-header d-flex justify-content-between align-items-center">
                        <h2><i class="bi bi-map"></i> Carte interactive</h2>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="openMapFullscreen()" title="Ouvrir la carte en plein écran">
                                <i class="bi bi-fullscreen"></i> Plein écran
                            </button>
                        </div>
                    </div>
                    <div class="position-relative">
                        <iframe src="{{ rapport.carte_url }}" width="100%" height="420" class="map-frame" title="Carte interactive de la commune" id="mainMapFrame"></iframe>
                        {% if rapport.carte_static_url %}
                        <img src="{{ rapport.carte_static_url }}" alt="Carte statique de la commune" class="print-map mt-2" />
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                <!-- Informations générales -->
                <div class="metric-card">
                    <div class="row">
                        <div class="col-md-8">
                            <h1><i class="bi bi-geo-alt"></i> {{ rapport.commune_info.caracteristiques_generales.nom }}</h1>
                            <p class="mb-2">
                                <strong>Superficie:</strong> {{ "%.2f"|format(rapport.commune_info.superficie_total_ha) }} ha<br>
                                <strong>Population:</strong> {{ rapport.commune_info.population or 'N/A' }} habitants<br>
                                <strong>Coordonnées centre:</strong> {{ "%.4f"|format(rapport.commune_info.centroid_lat) }}, {{ "%.4f"|format(rapport.commune_info.centroid_lon) }}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <small>
                                Rapport généré le {{ rapport.metadata.date_generation }}<br>
                                Version {{ rapport.metadata.version_rapport }}<br>
                                Sources: {{ rapport.metadata.sources_donnees|join(', ') }}
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Statistiques principales -->
                <!-- En-tête "Vue d'ensemble" retiré -->
                
                <div class="stats-grid">
                    <!-- RPG -->
                    {% if filters and filters.get('filter_rpg', True) and rapport.rpg_analysis %}
                    <div class="stat-box">
                        <div class="stat-value">{{ rapport.rpg_analysis.resume_executif.total_parcelles }}</div>
                        <div class="stat-label">Parcelles RPG</div>
                        <small>{{ "%.1f"|format(rapport.rpg_analysis.resume_executif.surface_totale_ha) }} ha</small>
                    </div>
                    {% endif %}

                    <!-- Éleveurs -->
                    {% if rapport.eleveurs and rapport.eleveurs.features %}
                    <div class="stat-box">
                        <div class="stat-value">{{ rapport.eleveurs.features | length }}</div>
                        <div class="stat-label">Éleveurs</div>
                        <small>Exploitants agricoles</small>
                    </div>
                    {% endif %}

                    <!-- Parkings -->
                    {% if filters and filters.get('filter_parkings', True) and rapport.parkings_analysis %}
                    <div class="stat-box">
                        <div class="stat-value">{{ rapport.parkings_analysis.resume_executif.total_parkings | default(0, true) }}</div>
                        <div class="stat-label">Parkings</div>
                        <small>{{ "%.1f"|format((rapport.parkings_analysis.resume_executif.potentiel_photovoltaique_mwc | default(0, true))) }} MWc pot.</small>
                    </div>
                    {% endif %}

                    <!-- Friches -->
                    {% if filters and filters.get('filter_friches', True) and rapport.friches_analysis %}
                    <div class="stat-box">
                        <div class="stat-value">{{ rapport.friches_analysis.resume_executif.total_friches }}</div>
                        <div class="stat-label">Friches</div>
                        <small>{{ "%.1f"|format(rapport.friches_analysis.resume_executif.surface_totale_ha) }} ha</small>
                    </div>
                    {% endif %}

                    <!-- Toitures -->
                    {% if filters and filters.get('filter_toitures', True) and rapport.toitures_analysis %}
                    <div class="stat-box">
                        <div class="stat-value">{{ rapport.toitures_analysis.resume_executif.total_toitures | default(0, true) }}</div>
                        <div class="stat-label">Toitures</div>
                        <small>{{ "%.1f"|format((rapport.toitures_analysis.resume_executif.potentiel_total_mwc | default(0, true))) }} MWc pot.</small>
                    </div>
                    {% endif %}

                    <!-- Zones d'urbanisme -->
                    {% if filters and filters.get('filter_zones', True) and rapport.zones_analysis %}
                    <div class="stat-box">
                        <div class="stat-value">{{ rapport.zones_analysis.resume_executif.total_zones }}</div>
                        <div class="stat-label">Zones d'urbanisme</div>
                        <small>{{ "%.1f"|format(rapport.zones_analysis.resume_executif.surface_totale_ha) }} ha</small>
                    </div>
                    {% endif %}

                    <!-- Irradiation (remplace Entreprises/SIRENE) -->
                    {% set irr = rapport.metadata.pvgis_kwh_per_kwc %}
                    {% if irr %}
                    <div class="stat-box">
                        <div class="stat-value">{{ '%.0f'|format(irr) }}</div>
                        <div class="stat-label">Irradiation (kWh/kWc/an)</div>
                        <small>Source: PVGIS</small>
                    </div>
                    {% endif %}
                </div>

                <!-- Analyse RPG -->
                {% if filters and filters.get('filter_rpg', True) and rapport.rpg_analysis %}
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h3><i class="bi bi-grid"></i> Analyse RPG (Registre Parcellaire Graphique)</h3>
                    <button class="btn btn-sm btn-outline-primary section-zoom-btn" 
                            data-section="rpg"
                            title="Zoom sur une parcelle RPG">
                        <i class="bi bi-zoom-in"></i> Voir sur carte
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="analysis-detail">
                            <h5>Cultures principales:</h5>
                            {% set cultures = rapport.rpg_analysis.get('resume_executif', {}).get('cultures_principales') %}
                            {% if cultures %}
                            <ul>
                                {%- for culture, surface in cultures[:5] -%}
                                <li><strong>{{ culture }}:</strong> {{ "%.1f"|format(surface) }} ha</li>
                                {%- endfor -%}
                            </ul>
                            {% else %}
                            <p>Aucune donnée disponible.</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analysis-detail">
                            <h6>Statistiques:</h6>
                            {% set surf_moy = (rapport.rpg_analysis.get('details_statistiques', {}).get('surface_moyenne_ha')
                                or rapport.rpg_analysis.get('resume_executif', {}).get('surface_moyenne_parcelle_ha')) %}
                            <p>
                                Surface moyenne: {{ "%.1f"|format(surf_moy or 0) }} ha<br>
                                Diversité cultures: {{ rapport.rpg_analysis.get('details_statistiques', {}).get('diversite_cultures') or (cultures | length if cultures else 0) }} types
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Détail des parcelles RPG filtrées -->
                {% if rapport.rpg_parcelles and rapport.rpg_parcelles.features %}
                <div class="analysis-detail mt-4">
                    <h5 class="mb-3">Parcelles agricoles filtrées ({{ rapport.rpg_parcelles.features | length }})</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Référence cadastrale</th>
                                    <th>Culture</th>
                                    <th>Surface (ha)</th>
                                    <th>Distance BT</th>
                                    <th>Distance HTA</th>
                                    <th>Position</th>
                                    <th>Zoom</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for parcelle in rapport.rpg_parcelles.features %}
                                {% set props = parcelle.properties %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        {% if props.section and props.numero %}
                                            {{ props.nom_com or rapport.nom }}<br>
                                            <small class="text-muted">{{ props.section }}{{ props.numero }}</small>
                                        {% else %}
                                            <span class="text-muted">Non référencée</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ props.Culture or 'Non définie' }}</strong>
                                        {% if props.code_culture %}
                                        <br><small class="text-muted">Code: {{ props.code_culture }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ "%.2f"|format(props.surface or 0) }}</td>
                                    <td>
                                        {% if props.distance_bt %}
                                            <span class="badge bg-success">{{ "%.0f"|format(props.distance_bt) }} m</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if props.distance_hta %}
                                            <span class="badge bg-info">{{ "%.0f"|format(props.distance_hta) }} m</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if props.coords %}
                                            <small>{{ "%.5f"|format(props.coords[0]) }}, {{ "%.5f"|format(props.coords[1]) }}</small>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if props.coords and props.coords|length >= 2 and props.coords[0] and props.coords[1] %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                title="Zoomer sur cette parcelle"
                                                onclick="zoomToLocation({{ props.coords[0] }}, {{ props.coords[1] }}, 'Parcelle agricole')">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- Détail des éleveurs sur la commune -->
                {% if rapport.eleveurs and rapport.eleveurs.features %}
                <div class="analysis-detail mt-4">
                    <h5 class="mb-3">🐄 Éleveurs et agriculteurs ({{ rapport.eleveurs.features | length }})</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nom/Dénomination</th>
                                    <th>Activité</th>
                                    <th>Adresse</th>
                                    <th>Coordonnées</th>
                                    <th>Zoom</th>
                                    <th>Liens</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for eleveur in rapport.eleveurs.features %}
                                {% set props = eleveur.properties %}
                                {% set coords = eleveur.geometry.coordinates if eleveur.geometry and eleveur.geometry.coordinates else [] %}
                                <tr>
                                    <td>
                                        <strong>
                                            {% if props.prenom and props.nom %}
                                                {{ props.prenom }} {{ props.nom }}
                                            {% elif props.nom %}
                                                {{ props.nom }}
                                            {% elif props.denomination %}
                                                {{ props.denomination }}
                                            {% else %}
                                                <span class="text-muted">Non renseigné</span>
                                            {% endif %}
                                        </strong>
                                        {% if props.denomination and (props.prenom or props.nom) %}
                                        <br><small class="text-muted">{{ props.denomination }}</small>
                                        {% endif %}
                                        {% if props.siret %}
                                        <br><small class="text-info">SIRET: {{ props.siret }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ props.activite or 'Non renseignée' }}</td>
                                    <td>
                                        {% if props.adresse and props.adresse.strip() %}
                                            {{ props.adresse }}
                                        {% else %}
                                            <span class="text-muted">Non renseignée</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if coords and coords|length >= 2 %}
                                            <small>
                                                <strong>Lat:</strong> {{ "%.5f"|format(coords[1]) }}<br>
                                                <strong>Lon:</strong> {{ "%.5f"|format(coords[0]) }}
                                            </small>
                                            <br><a href="https://www.google.com/maps?q={{ coords[1] }},{{ coords[0] }}" target="_blank" class="btn btn-xs btn-outline-secondary">
                                                <i class="bi bi-geo-alt"></i> Carte
                                            </a>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if coords and coords|length >= 2 and coords[0] and coords[1] %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                title="Zoomer sur cet éleveur"
                                                onclick="zoomToLocation({{ coords[1] }}, {{ coords[0] }}, 'Eleveur')">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column gap-1">
                                            {% if props.lien_entreprise %}
                                            <a href="{{ props.lien_entreprise }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-building"></i> Société.com
                                            </a>
                                            {% endif %}
                                            {% if props.lien_annuaire %}
                                            <a href="{{ props.lien_annuaire }}" target="_blank" class="btn btn-sm btn-outline-info">
                                                <i class="bi bi-telephone"></i> Pages Jaunes
                                            </a>
                                            {% endif %}
                                            {% if props.lien_pages_blanches %}
                                            <a href="{{ props.lien_pages_blanches }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                <i class="bi bi-person"></i> Pages Blanches
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                {% endif %}

                <!-- Analyse Parkings -->
                {% if filters and filters.get('filter_parkings', True) %}
                {% set parkings = rapport.get('parkings_analysis', {}) %}
                {% set park_rs = parkings.get('resume_executif', {}) %}
                {% if park_rs.get('total_parkings', 0) > 0 %}
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h3><i class="bi bi-car-front"></i> Analyse Parkings</h3>
                    <button class="btn btn-sm btn-outline-primary section-zoom-btn" 
                            data-section="parkings"
                            title="Zoom sur un parking">
                        <i class="bi bi-zoom-in"></i> Voir sur carte
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="analysis-detail">
                            <h6>Potentiel photovoltaïque:</h6>
                            <p>
                                Puissance installable: <strong>{{ "%.2f"|format(park_rs.get('potentiel_photovoltaique_mwc', 0)) }} MWc</strong><br>
                                Production annuelle: <strong>{{ "%.0f"|format(park_rs.get('production_annuelle_mwh', 0)) }} MWh/an</strong><br>
                                Surface totale: {{ "%.0f"|format(park_rs.get('surface_totale_m2', 0)) }} m²
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        {% set ar = parkings.get('analyse_reseau') %}
                        {% if ar %}
                        <div class="analysis-detail">
                            <h6>Analyse réseau:</h6>
                            <p>
                                Distance moy. BT: {{ "%.0f"|format(ar.distance_moyenne_bt_m | default(0, true)) }} m<br>
                                Distance moy. HTA: {{ "%.0f"|format(ar.distance_moyenne_hta_m | default(0, true)) }} m
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% set park_details = parkings.get('details', []) %}
                {% if park_details and (park_details | length) > 0 %}
                <div class="analysis-detail">
                    <h6 class="mb-3">Détails des parkings ({{ park_details | length }})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Surface (m²)</th>
                                    <th>Parcelles</th>
                                    <th>BT le plus proche</th>
                                    <th>HTA le plus proche</th>
                                    <th>Position</th>
                                    <th>Zoom</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in park_details %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ '%.0f'|format(d.surface_m2 | default(0, true)) }}</td>
                                    <td>
                                        {% if d.parcelles %}
                                            <ul class="mb-0">{%- for p in d.parcelles -%}<li>{{ p.reference_complete or (p.section ~ p.numero) }}</li>{%- endfor -%}</ul>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set bt = d.poste_bt_proche or {} %}
                                        {% if bt.distance_m %}
                                            {{ bt.id or bt.nom or 'BT' }}<br><small>{{ '%.0f'|format(bt.distance_m) }} m<br>{{ '%.5f'|format(bt.lat) }}, {{ '%.5f'|format(bt.lon) }}</small>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set hta = d.poste_hta_proche or {} %}
                                        {% if hta.distance_m %}
                                            {{ hta.id or hta.nom or 'HTA' }}<br><small>{{ '%.0f'|format(hta.distance_m) }} m<br>{{ '%.5f'|format(hta.lat) }}, {{ '%.5f'|format(hta.lon) }}</small>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ '%.5f'|format(d.lat) }}, {{ '%.5f'|format(d.lon) }}</small></td>
                                    <td>
                                        {% if d.lat and d.lon %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                title="Zoomer sur ce parking"
                                                onclick="zoomToLocation({{ d.lat }}, {{ d.lon }}, 'Parking')">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                {% endif %}
                {% endif %}

                <!-- Analyse Friches -->
                {% if filters and filters.get('filter_friches', True) and rapport.friches_analysis and rapport.friches_analysis.resume_executif.total_friches > 0 %}
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h3><i class="bi bi-building"></i> Analyse Friches</h3>
                    <button class="btn btn-sm btn-outline-primary section-zoom-btn" 
                            data-section="friches"
                            title="Zoom sur une friche">
                        <i class="bi bi-zoom-in"></i> Voir sur carte
                    </button>
                </div>
                
                <div class="analysis-detail">
                    <p>
                        <strong>{{ rapport.friches_analysis.resume_executif.total_friches }}</strong> friches identifiées<br>
                        Surface totale: <strong>{{ "%.1f"|format(rapport.friches_analysis.resume_executif.surface_totale_ha) }} ha</strong><br>
                        Potentiel de reconversion: {{ "%.1f"|format(rapport.friches_analysis.resume_executif.potentiel_reconversion_ha) }} ha
                    </p>
                </div>

                {% set fr_details = rapport.friches_analysis.get('details', []) %}
                {% if fr_details and (fr_details | length) > 0 %}
                <div class="analysis-detail">
                    <h6 class="mb-3">Détails des friches ({{ fr_details | length }})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Surface (ha)</th>
                                    <th>Parcelles</th>
                                    <th>BT le plus proche</th>
                                    <th>HTA le plus proche</th>
                                    <th>Position</th>
                                    <th>Zoom</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in fr_details %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ '%.2f'|format(d.surface_ha | default(0, true)) }}</td>
                                    <td>
                                        {% if d.parcelles %}
                                            <ul class="mb-0">{%- for p in d.parcelles -%}<li>{{ p.reference_complete or (p.section ~ p.numero) }}</li>{%- endfor -%}</ul>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set bt = d.poste_bt_proche or {} %}
                                        {% if bt.distance_m %}
                                            {{ bt.id or bt.nom or 'BT' }}<br><small>{{ '%.0f'|format(bt.distance_m) }} m<br>{{ '%.5f'|format(bt.lat) }}, {{ '%.5f'|format(bt.lon) }}</small>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set hta = d.poste_hta_proche or {} %}
                                        {% if hta.distance_m %}
                                            {{ hta.id or hta.nom or 'HTA' }}<br><small>{{ '%.0f'|format(hta.distance_m) }} m<br>{{ '%.5f'|format(hta.lat) }}, {{ '%.5f'|format(hta.lon) }}</small>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ '%.5f'|format(d.lat) }}, {{ '%.5f'|format(d.lon) }}</small></td>
                                    <td>
                                        {% if d.lat and d.lon %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                title="Zoomer sur cette friche"
                                                onclick="zoomToLocation({{ d.lat }}, {{ d.lon }}, 'Friche')">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                {% endif %}

                <!-- Analyse Toitures -->
                {% if filters and filters.get('filter_toitures', True) %}
                {% set toits_rs = rapport.get('toitures_analysis', {}).get('resume_executif', {}) %}
                {% if toits_rs.get('total_toitures', 0) > 0 %}
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h3><i class="bi bi-house"></i> Analyse Toitures</h3>
                    <button class="btn btn-sm btn-outline-primary section-zoom-btn" 
                            data-section="toitures"
                            title="Zoom sur une toiture">
                        <i class="bi bi-zoom-in"></i> Voir sur carte
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="analysis-detail">
                            <h6>Potentiel global:</h6>
                            <p>
                                Bâtiments: {{ toits_rs.get('total_toitures', 0) }}<br>
                                Surface exploitable: {{ "%.0f"|format(toits_rs.get('surface_exploitable_pv_m2', 0)) }} m²
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analysis-detail">
                            <h6>Capacité installable:</h6>
                            <p>
                                Puissance: <strong>{{ "%.1f"|format(toits_rs.get('potentiel_total_mwc', 0)) }} MWc</strong><br>
                                Production: {{ "%.0f"|format(toits_rs.get('production_annuelle_mwh', 0)) }} MWh/an
                            </p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analysis-detail">
                            <h6>Typologie:</h6>
                            {% if rapport.toitures_analysis.details_typologie %}
                            <ul class="mb-0">{%- for type_bat, count in rapport.toitures_analysis.details_typologie.repartition_types_batiments.items() -%}<li>{{ type_bat }}: {{ count }}</li>{%- endfor -%}</ul>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% set toit_details = rapport.get('toitures_analysis', {}).get('details', []) %}
                {% if toit_details and (toit_details | length) > 0 %}
                <div class="analysis-detail">
                    <h6 class="mb-3">Détails des toitures ({{ toit_details | length }})</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Surface (m²)</th>
                                    <th>Parcelles</th>
                                    <th>BT le plus proche</th>
                                    <th>HTA le plus proche</th>
                                    <th>Position</th>
                                    <th>Zoom</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for d in toit_details %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>{{ '%.0f'|format(d.surface_m2 | default(0, true)) }}</td>
                                    <td>
                                        {% if d.parcelles %}
                                            <ul class="mb-0">{%- for p in d.parcelles -%}<li>{{ p.reference_complete or (p.section ~ p.numero) }}</li>{%- endfor -%}</ul>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set bt = d.poste_bt_proche or {} %}
                                        {% if bt.distance_m %}
                                            {{ bt.id or bt.nom or 'BT' }}<br><small>{{ '%.0f'|format(bt.distance_m) }} m<br>{{ '%.5f'|format(bt.lat) }}, {{ '%.5f'|format(bt.lon) }}</small>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set hta = d.poste_hta_proche or {} %}
                                        {% if hta.distance_m %}
                                            {{ hta.id or hta.nom or 'HTA' }}<br><small>{{ '%.0f'|format(hta.distance_m) }} m<br>{{ '%.5f'|format(hta.lat) }}, {{ '%.5f'|format(hta.lon) }}</small>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td><small>{{ '%.5f'|format(d.lat) }}, {{ '%.5f'|format(d.lon) }}</small></td>
                                    <td>
                                        {% if d.lat and d.lon %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                title="Zoomer sur cette toiture"
                                                onclick="zoomToLocation({{ d.lat }}, {{ d.lon }}, 'Toiture')">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                {% endif %}
                {% endif %}

                <!-- Analyse Zones d'urbanisme -->
                {% if filters and filters.get('filter_zones', True) %}
                {% set zones = rapport.get('zones_analysis', {}) %}
                {% set zones_rs = zones.get('resume_executif', {}) %}
                {% if zones_rs.get('total_zones', 0) > 0 %}
                <div class="section-header d-flex justify-content-between align-items-center">
                    <h3><i class="bi bi-map"></i> Analyse Zones d'urbanisme</h3>
                    <button class="btn btn-sm btn-outline-primary section-zoom-btn" 
                            data-section="zones"
                            title="Zoom sur une zone d'urbanisme">
                        <i class="bi bi-zoom-in"></i> Voir sur carte
                    </button>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="analysis-detail">
                            <h5>Types de zones principaux:</h5>
                            {% set types_zones = zones_rs.get('types_zones', []) %}
                            {% if types_zones %}
                            <ul>
                                {%- for type_zone, surface in types_zones[:5] -%}
                                <li><strong>{{ type_zone }}:</strong> {{ "%.1f"|format(surface) }} ha</li>
                                {%- endfor -%}
                            </ul>
                            {% else %}
                            <p>Aucune donnée disponible.</p>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analysis-detail">
                            <h6>Statistiques:</h6>
                            <p>
                                Surface totale: <strong>{{ "%.1f"|format(zones_rs.get('surface_totale_ha', 0)) }} ha</strong><br>
                                Surface moyenne: {{ "%.1f"|format(zones_rs.get('surface_moyenne_ha', 0)) }} ha<br>
                                Nombre de zones: {{ zones_rs.get('total_zones', 0) }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Détail des zones filtrées -->
                {% if rapport.zones and rapport.zones.features %}
                <div class="analysis-detail mt-4">
                    <h5 class="mb-3">Zones d'urbanisme filtrées ({{ rapport.zones.features | length }})</h5>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Type de zone</th>
                                    <th>Libellé</th>
                                    <th>Surface (ha)</th>
                                    <th>Parcelles cadastrales</th>
                                    <th>Distance BT</th>
                                    <th>Distance HTA</th>
                                    <th>Position</th>
                                    <th>Zoom</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for zone in rapport.zones.features %}
                                {% set props = zone.properties %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <strong>{{ props.typezone or 'Non défini' }}</strong>
                                        {% if props.destdomi %}
                                        <br><small class="text-muted">{{ props.destdomi }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ props.libelle or props.libelong or 'Non renseigné' }}
                                        {% if props.nomfic %}
                                        <br><small class="text-muted">{{ props.nomfic }}</small>
                                        {% endif %}
                                    </td>
                                    <td>{{ "%.2f"|format(props.surface_ha or 0) }}</td>
                                    <td>
                                        {% if props.parcelles_cadastrales and props.parcelles_cadastrales | length > 0 %}
                                            <span class="badge bg-primary">{{ props.nb_parcelles_cadastrales or props.parcelles_cadastrales | length }} parcelles</span>
                                            <br>
                                            <small class="text-muted">
                                                {%- for parcelle in props.parcelles_cadastrales -%}
                                                    {{ parcelle.ref }}{% if not loop.last %}, {% endif %}
                                                {%- endfor -%}
                                            </small>
                                        {% else %}
                                            <span class="text-muted">Non renseignées</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if props.distance_bt %}
                                            <span class="badge bg-success">{{ "%.0f"|format(props.distance_bt) }} m</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if props.distance_hta %}
                                            <span class="badge bg-info">{{ "%.0f"|format(props.distance_hta) }} m</span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if props.coords %}
                                            <small>{{ "%.5f"|format(props.coords[0]) }}, {{ "%.5f"|format(props.coords[1]) }}</small>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if props.coords and props.coords|length >= 2 and props.coords[0] and props.coords[1] %}
                                        <button class="btn btn-sm btn-outline-primary" 
                                                title="Zoomer sur cette zone"
                                                onclick="zoomToLocation({{ props.coords[0] }}, {{ props.coords[1] }}, 'Zone urbanisme')">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                {% endif %}
                {% endif %}

                <!-- Sections Environnement, Synthèse/Recommandations et Informations Techniques retirées à la demande -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Fonction pour ouvrir la carte en plein écran
        function openMapFullscreen() {
            const iframe = document.querySelector('iframe.map-frame');
            if (iframe && iframe.src) {
                // Ouvrir la carte dans un nouvel onglet
                window.open(iframe.src, '_blank', 'width=1200,height=800');
            } else {
                alert('Carte non disponible');
            }
        }
        
        // Fonction pour zoomer - Version alternative qui ouvre un nouvel onglet
        function zoomToLocation(lat, lng, name, type) {
            // Validation des paramètres
            if (!lat || !lng || isNaN(lat) || isNaN(lng)) {
                console.error('Coordonnées invalides:', { lat, lng, name, type });
                alert('Coordonnées invalides pour ce zoom');
                return;
            }
            
            // Essayer d'abord la méthode postMessage
            const iframe = document.querySelector('iframe.map-frame');
            console.log('Iframe trouvée:', iframe);
            
            if (iframe) {
                // Fonction pour envoyer le message
                function sendZoomMessage() {
                    const message = {
                        action: 'zoomTo',
                        lat: parseFloat(lat),
                        lng: parseFloat(lng),
                        zoom: 16,
                        name: name || 'Élément',
                        type: type || 'Point'
                    };
                    
                    console.log('Envoi message zoom:', message);
                    
                    try {
                        iframe.contentWindow.postMessage(message, '*');
                        console.log('Message envoyé avec succès');
                        
                        // Feedback visuel
                        showZoomFeedback(name || 'Élément', type || 'Point');
                    } catch (error) {
                        console.error('Erreur lors de l\'envoi du message:', error);
                        // Fallback: ouvrir dans un nouvel onglet avec Google Maps
                        const mapUrl = `https://www.google.com/maps?q=${lat},${lng}&z=16`;
                        window.open(mapUrl, '_blank');
                    }
                }
                
                // Si l'iframe est déjà chargée, envoyer immédiatement
                if (iframe.contentWindow) {
                    sendZoomMessage();
                } else {
                    // Sinon, attendre que l'iframe soit chargée
                    iframe.onload = sendZoomMessage;
                    // Fallback: essayer après un délai
                    setTimeout(sendZoomMessage, 1000);
                }
            } else {
                console.error('Iframe map-frame non trouvée');
                // Fallback: ouvrir Google Maps
                const mapUrl = `https://www.google.com/maps?q=${lat},${lng}&z=16`;
                window.open(mapUrl, '_blank');
            }
        }
        
        // Fonction principale de zoom - solution alternative robuste
        function zoomToLocation(lat, lng, name, type) {
            console.log('Zoom demandé:', lat, lng, name, type);
            
            // Valider les coordonnées
            if (!lat || !lng || lat === 'undefined' || lng === 'undefined') {
                console.error('Coordonnées invalides:', lat, lng);
                alert('Coordonnées invalides pour cet élément');
                return;
            }
            
            // Convertir en nombres
            const latitude = parseFloat(lat);
            const longitude = parseFloat(lng);
            
            if (isNaN(latitude) || isNaN(longitude)) {
                console.error('Coordonnées non numériques:', latitude, longitude);
                alert('Coordonnées non valides');
                return;
            }
            
            // Afficher le feedback
            showZoomFeedback(name || 'Point', type || 'position');
            
            // Construire l'URL de la carte avec les coordonnées - version corrigée
            const protocol = window.location.protocol;
            const host = window.location.host;
            const baseUrl = `${protocol}//${host}`;
            const mapUrl = `${baseUrl}/generated_map?lat=${latitude}&lng=${longitude}&zoom=17&name=${encodeURIComponent(name || 'Point')}`;
            
            console.log('URL de zoom construite:', mapUrl);
            
            // Essayer d'ouvrir dans un nouvel onglet
            const mapWindow = window.open(mapUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            // Vérifier si le popup a été bloqué
            setTimeout(() => {
                if (!mapWindow || mapWindow.closed || typeof mapWindow.closed == 'undefined') {
                    // Popup bloqué, proposer une alternative
                    const confirmation = confirm(
                        'Les popups sont bloqués.\n\n' +
                        'Voulez-vous ouvrir la carte dans l\'onglet actuel ?\n\n' +
                        '⚠️ Cela remplacera la page du rapport.'
                    );
                    
                    if (confirmation) {
                        // Ouvrir dans l'onglet actuel
                        window.location.href = mapUrl;
                    } else {
                        // Copier l'URL dans le presse-papier si possible
                        if (navigator.clipboard) {
                            navigator.clipboard.writeText(mapUrl).then(() => {
                                alert('URL de la carte copiée dans le presse-papier.\nVous pouvez la coller dans un nouvel onglet.');
                            }).catch(() => {
                                alert('Veuillez autoriser les popups ou copier cette URL manuellement:\n\n' + mapUrl);
                            });
                        } else {
                            alert('Veuillez autoriser les popups ou copier cette URL manuellement:\n\n' + mapUrl);
                        }
                    }
                } else {
                    // Popup ouvert avec succès
                    console.log('Carte ouverte avec succès dans un nouvel onglet');
                    mapWindow.focus();
                }
            }, 100);
        }
        
        // Fonction pour ouvrir la carte locale en plein écran avec tous les calques
        function openMapFullscreen() {
            // Chercher l'iframe de la carte par ID d'abord, puis par classe
            const mapIframe = document.querySelector('#mainMapFrame') || document.querySelector('iframe.map-frame') || document.querySelector('iframe[src*="map.html"]');
            if (mapIframe) {
                // Construire l'URL complète de votre carte avec tous les paramètres
                let mapUrl = mapIframe.src;
                
                // Ajouter un paramètre pour indiquer le mode plein écran
                if (mapUrl.includes('?')) {
                    mapUrl += '&fullscreen=true';
                } else {
                    mapUrl += '?fullscreen=true';
                }
                
                // Ouvrir votre carte locale dans un nouvel onglet en plein écran
                const fullscreenWindow = window.open(mapUrl, '_blank', 'fullscreen=yes,scrollbars=yes,resizable=yes,width=1920,height=1080');
                if (fullscreenWindow) {
                    fullscreenWindow.focus();
                    
                    // Optionnel: demander le plein écran navigateur
                    setTimeout(() => {
                        try {
                            fullscreenWindow.document.documentElement.requestFullscreen();
                        } catch (e) {
                            console.log('Plein écran automatique non supporté');
                        }
                    }, 1000);
                } else {
                    alert('Popup bloqué - veuillez autoriser les popups pour ouvrir la carte en plein écran');
                }
            } else {
                alert('Carte non trouvée');
            }
        }
        
        // Feedback visuel pour confirmer le zoom
        function showZoomFeedback(name, type) {
            // Créer une notification temporaire
            const notification = document.createElement('div');
            notification.className = 'alert alert-success position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="bi bi-zoom-in"></i> 
                Zoom sur: <strong>${name}</strong> 
                <small>(${type})</small>
            `;
            
            document.body.appendChild(notification);
            
            // Supprimer après 3 secondes
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Fonction simplifiée pour zoomer sur une section (fallback vers Google Maps)
        function zoomToSection(sectionType) {
            alert('Fonction de zoom par section - utilisez les boutons de zoom individuels pour plus de précision');
        }
        
        // Gestionnaire d'événements pour les boutons de zoom
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM chargé, initialisation des boutons de zoom');
            
            // Boutons de zoom individuels
            document.querySelectorAll('.zoom-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const lat = this.getAttribute('data-lat');
                    const lng = this.getAttribute('data-lng');
                    const name = this.getAttribute('data-name');
                    const type = this.getAttribute('data-type');
                    
                    console.log('Clic sur bouton zoom:', lat, lng, name, type);
                    zoomToLocation(lat, lng, name, type);
                });
            });
            
            // Boutons de zoom par section
            document.querySelectorAll('.section-zoom-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionType = this.getAttribute('data-section');
                    zoomToSection(sectionType);
                });
            });
            
            console.log('Boutons de zoom initialisés:', document.querySelectorAll('.zoom-btn').length, 'individuels,', document.querySelectorAll('.section-zoom-btn').length, 'sections');
        });
    </script>
</body>
</html>
